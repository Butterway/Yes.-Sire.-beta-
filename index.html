<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0,viewport-fit=cover" name="viewport"/>
<title>Yes, Sire. - V9.7.5</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;display=swap" rel="stylesheet"/>
<style>
  :root{
    /* Themed dropdown styling */
select.input {
  background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--ui-radius);
  color: var(--fg);
  font-weight: 600;
  padding: 8px 10px;
  appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg fill="%23eaf4ff" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,7 15,7 10,12"/></svg>');
  background-repeat: no-repeat;
  background-position: right 8px center;
  background-size: 14px;
}
select.input:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--accent-a);
}
    --bg-dark-1:#071029; --bg-dark-2:#07182b;
    --fg:#eaf4ff; --muted:#9fb0c8;
    --accent-a:#ff7a18; --accent-b:#ffd166;
    --glass: rgba(255,255,255,0.03);
    --good:#64d368; --bad:#ff6b6b;
    --max-width:1180px;
    --ui-radius:14px;
  }

  /* Basic layout */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));color:var(--fg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .app{min-height:100vh;display:flex;align-items:stretch;padding:22px;justify-content:center}
  .container{width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr 380px;gap:18px;position:relative;z-index:2}

  /* Fluid animated background blobs */
  .bg-blobs{position:fixed;inset:0;overflow:hidden;z-index:0;pointer-events:none}
  .blob{
    position:absolute;
    width:60vmax;height:60vmax;border-radius:50%;
    filter:blur(60px) saturate(120%);
    transform-origin:center;
    mix-blend-mode:screen;
    opacity:0.55;
    will-change:transform,opacity,left,top;
  }
  .blob.b1{ left:-10%; top:-20%; background: radial-gradient(circle at 30% 30%, #ff8a65 0%, #ff6b6b 30%, rgba(255,107,107,0.0) 60%); animation: blobMove1 32s linear infinite; }
  .blob.b2{ left:60%; top:-10%; background: radial-gradient(circle at 50% 40%, #ffd166 0%, #ff7a18 30%, rgba(255,122,24,0) 60%); animation: blobMove2 38s linear infinite; opacity:0.48; }
  .blob.b3{ left:20%; top:50%; background: radial-gradient(circle at 40% 60%, #7ee7c7 0%, #4fd1c5 30%, rgba(79,209,197,0) 60%); animation: blobMove3 46s linear infinite; opacity:0.42; }
  .blob.b4{ left:70%; top:50%; background: radial-gradient(circle at 60% 60%, #9fd3ff 0%, #6fb9ff 30%, rgba(111,185,255,0) 60%); animation: blobMove4 52s linear infinite; opacity:0.28; }

  /* floating particles layer */
  .particles{position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:0.06}
  .particles::before{
    content:"";position:absolute;left:50%;top:50%;width:160vmax;height:160vmax;margin-left:-80vmax;margin-top:-80vmax;
    background:
      radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 0 1px, transparent 1px),
      radial-gradient(circle at 80% 30%, rgba(255,255,255,0.02) 0 1px, transparent 1px),
      radial-gradient(circle at 40% 70%, rgba(255,255,255,0.02) 0 1px, transparent 1px);
    background-size: 3vmin 3vmin;
    transform: translateZ(0);
    animation: particlesFloat 18s linear infinite;
  }

  @keyframes blobMove1{ 0%{transform:translate3d(0,0,0) scale(1)} 50%{transform:translate3d(8vmin,6vmin,0) scale(1.06)} 100%{transform:translate3d(0,0,0) scale(1)} }
  @keyframes blobMove2{ 0%{transform:translate3d(0,0,0) scale(1)} 50%{transform:translate3d(-6vmin,8vmin,0) scale(1.08)} 100%{transform:translate3d(0,0,0) scale(1)} }
  @keyframes blobMove3{ 0%{transform:translate3d(0,0,0) scale(1)} 50%{transform:translate3d(10vmin,-8vmin,0) scale(0.98)} 100%{transform:translate3d(0,0,0) scale(1)} }
  @keyframes blobMove4{ 0%{transform:translate3d(0,0,0) scale(1)} 50%{transform:translate3d(-10vmin,-6vmin,0) scale(1.04)} 100%{transform:translate3d(0,0,0) scale(1)} }
  @keyframes particlesFloat{ 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }

  /* Container cards */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--ui-radius); padding:14px; box-shadow:0 10px 40px rgba(0,0,0,0.6);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.02)}
  /* Fixed height scenario card with fade-out and smart vertical alignment */



  /* Scenario card smart alignment */



  .header{display:flex;justify-content:space-between;align-items:center}
  .scene{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;padding:18px;border-radius:14px;background:transparent}
  .scene-card{
    width:100%;max-width:980px;padding:28px;border-radius:12px;box-shadow:0 18px 44px rgba(0,0,0,0.55);
    transition: transform .45s cubic-bezier(.2,.9,.2,1), box-shadow .28s;
    /* improved animated gradient for the card */
    position:relative; overflow:hidden; color: #fff; text-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  @keyframes sheenMove{ 0%{transform:translateX(-30%)} 50%{transform:translateX(30%)} 100%{transform:translateX(-30%)} }

  .choices{display:flex;gap:14px;margin-top:14px}
  .choice{
    flex:1;padding:16px;border-radius:12px;border:0;font-weight:800;cursor:pointer;
    background: linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#081428; box-shadow: 0 8px 28px rgba(0,0,0,0.45);
    transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s, filter .18s;
    will-change: transform, filter;
  }
  .choice.secondary{ background: linear-gradient(90deg,#9fd3ff,#bfe6ff); color:#032033; }
  .choice:hover{ transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 48px rgba(0,0,0,0.6); filter:brightness(1.02); }
  .choice:active{ transform: translateY(-2px) scale(0.995); }
  
.essence-bar {
  position: relative;8 
  overflow: hidden;
}

/* overlay element */
.essence-bar::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  opacity: 0;                      /* start hidden */
  transition: opacity 0.8s ease;   /* fade timing */
}

/* show overlay immediately on gain/loss */
.essence-bar.gain::after {
  background: rgba(0, 255, 0, 0.3);
  opacity: 1;
}
.essence-bar.loss::after {
  background: rgba(255, 0, 0, 0.3);
  opacity: 1;
}

/* then fade the overlay out (bar stays visible) */
.essence-bar.fadeout::after {
  opacity: 0;
}

/* optional: respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .essence-bar::after { transition: none !important; }
}

  /* Essence bars */
  .essences{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;margin-top:12px}
  .ess{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent); transition: transform .25s, box-shadow .25s; }
  .ess:hover{ transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .label{width:140px;font-size:14px;color:var(--muted);white-space:nowrap;display:flex;align-items:center;gap:8px;padding-left:6px}
  .bar{flex:1;height:14px;background:rgba(255,255,255,0.03);border-radius:12px;overflow:hidden;position:relative}
  .bar > i{height:100%;display:block;transition:width .6s cubic-bezier(.2,.9,.3,1), background .3s, box-shadow .3s}
  .value{width:44px;text-align:right;font-weight:800}

  .log{height:160px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01));font-size:13px;margin-top:10px}
  .traits{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
  .trait{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px}

  /* small responsive */
  @media(max-width:980px){ .container{grid-template-columns:1fr;gap:12px} .label{width:120px} .choice{font-size:18px} }

  /* darker overlay behind UI to improve contrast with blobs */
  .app::after{content:"";position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,12,0.22), rgba(2,6,12,0.42));z-index:1;pointer-events:none}

  /* subtle keyframe for slight scaling of important panels */
  @keyframes popIn{ from{transform:translateY(6px) scale(.995);opacity:0.0} to{transform:none;opacity:1} }

  /* preferences for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .blob, .particles::before, .scene-card::before, .choice, .ess{ animation:none !important; transition:none !important; transform:none !important; }
  }


/* Modal overlay & persona floating window */
.overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: linear-gradient(180deg, rgba(2,6,12,0.45), rgba(2,6,12,0.6));
  backdrop-filter: blur(4px);
  z-index:50;
}

.overlay .card:focus{ box-shadow: 0 30px 90px rgba(2,6,23,0.9), 0 0 0 4px rgba(255,255,255,0.04); }
.overlay .choice{ min-height:44px; padding:12px; }
.overlay[aria-hidden="false"] { display:flex; }

#sceneCard {
  position: relative;
  height: 140px;
  overflow-y: auto;
  padding: 10px 14px;
  display: flex;
}

#sceneCard.centered {
  align-items: center;
  justify-content: center;
}
  align-items: center;
  justify-content: center;
}

#sceneCard.topAligned {
  align-items: flex-start;
}

.sceneText {
  text-align: center;
  max-width: 100%;
  display: inline-block;
  max-width: 100%;
}
  text-align: center;
  width: 100%;
}

#sceneCard::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 32px;
  background: linear-gradient(to bottom, rgba(7,16,41,0), var(--bg-dark-1));
  pointer-events: none;
}

.sceneWrapper {
  width: 100%;
  display: flex;
  justify-content: center;
}
  /* V9.8: Fade-in + slight pop for Mini Event announcements */
@keyframes fadeInPop {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.fade-in-pop {
  animation: fadeInPop 0.4s ease;
}

  /* V9.8: Highlight style for Mini Event log entries */
.mini-event-log {
  color: var(--accent-a);
  font-weight: 700;
}
/* V9.7.5: NPC Scenario styling */
.npc-scenario {
  border: 3px solid gold;
  box-shadow: 0 0 18px gold;
}

/* Overlay with blur */
.queen-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(4px);
  opacity: 0;
  transition: opacity 0.3s ease;
  display: flex;
  align-items: center;   /* vertical center */
  justify-content: center; /* horizontal center */
  z-index: 9998;
}

.queen-popup-overlay.show {
  opacity: 1;
}

.queen-popup {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  padding: 20px 25px;
  max-width: 80%;
  text-align: center;
  font-style: italic;
  font-weight: 300;
  font-size: 18px;
  transform: scale(0.9); /* start small */
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
  z-index: 9999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.queen-popup.show {
  transform: scale(1);
  opacity: 1;
}

.queen-popup-text {
  margin-bottom: 12px;
  color: #000;
}

/* Ending color themes */
.queen-fail-early {
  background: rgba(200, 200, 200, 0.95); /* cold gray */
}

.queen-fail-mid {
  background: rgba(218, 165, 32, 0.9); /* faded gold */
}

.queen-fail-late {
  background: rgba(139, 0, 0, 0.9); /* deep crimson */
}

.queen-success {
  background: rgba(128, 0, 128, 0.9); /* royal purple */
  color: #fff;
}

/* Close button */
.queen-popup-close {
  margin-top: 15px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  color: #000;
  cursor: pointer;
  transition: background 0.3s;
}

.queen-popup-close:hover {
  background: rgba(255, 255, 255, 1);
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

.app {
  display: flex;
  justify-content: center;  /* center horizontally */
  width: 100%;
  min-height: 100%;
}

.container {
  width: calc(100vw);
  height: auto;
}

.toggle-btn {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s ease;
}

.toggle-btn:hover {
  background: rgba(255,255,255,0.15);
  color: var(--fg);
}

.toggle-btn.on {
  background: linear-gradient(90deg,var(--accent-a),var(--accent-b));
  color: #081428;
  font-weight: 600;
}

/* Disable all moving background effects when no-bg-animations is active */
.no-bg-animations .blob {
  animation: none !important;
  opacity: 0 !important; /* Hide the colored blobs entirely */
}

.no-bg-animations .particles::before {
  animation: none !important;
  opacity: 0 !important; /* Hide particles */
}

.no-bg-animations .scene-card::before {
  animation: none !important;
  opacity: 0 !important; /* Hide sheen effect */
}

/* Completely disable background blobs, particles, and their colors */
.no-bg-animations .blob {
  animation: none !important;
  background: none !important; /* remove gradient colors */
  opacity: 0 !important;       /* hide element entirely */
}

.no-bg-animations .particles::before {
  animation: none !important;
  background: none !important; /* remove particle glow */
  opacity: 0 !important;
}

.no-bg-animations .scene-card::before {
  animation: none !important;
  background: none !important; /* remove sheen gradient */
  opacity: 0 !important;
}

.footer-small {
  font-size: 0.75em;     /* smaller text */
  font-style: italic;    /* italicized */
  opacity: 0.5;          /* subtle */
  margin-top: 12px;      /* move it further down */
  pointer-events: none;  /* prevent blocking clicks */
}

.footer-small {
  pointer-events: none; /* prevents it from blocking clicks */
}

#startBtn {
  width: 100px;   /* adjust as needed */
  height: 50px;   /* adjust as needed */
  font-size: 1.1em; /* optional: scale text */
}
 
#difficulty,
#theme {
  width: 160px;
  height: 22px; /* Match Previews button height */
  font-size: 0.85em;
  font-family: inherit;
  font-weight: inherit;
  border-radius: 6px;
  padding: 0 6px;
}

#difficulty:hover {
  background: linear-gradient(180deg, #555, #333); /* Match hover effect */
}

/* General card styling already applies */
#logCard {
  margin-top: 12px; /* spacing from the first card */
}


@keyframes glowFade {
    0% { box-shadow: 0 0 18px rgba(50, 205, 50, 0.8); }
    100% { box-shadow: none; }
}

/* =====================
   LIGHT THEME (START)
   ===================== */ 
   
/* Light mode variant (matches other main cards) */
body.light-mode #logCard {
  background: rgba(255, 255, 255, 0.30);
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  color: #1b4793;
  border: 1px solid rgba(15, 51, 107, 0.25);
}

/* Prevent dropdowns from turning dark when focused */
select.input:focus {
  outline: none !important;
  background: inherit !important; /* keep same background as normal */
  color: inherit !important;
}

/* Light mode - match glass style */
body.light-mode select.input:focus {
  background: rgba(255, 255, 255, 0.30) !important;
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border: 1px solid rgba(15, 51, 107, 0.25) !important;
  color: #0f336b !important;
}
   
   /* Light mode overlay - much lighter backdrop so glass cards stay bright */
body.light-mode .overlay {
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.6)) !important;
}
 
/* Brighter light mode for Persona Selection & Mini Event popups */
body.light-mode #nameOverlay .card,
body.light-mode #miniEventOverlay .card {
  background: rgba(255, 255, 255, 0.01) !important; /* glass white */
  backdrop-filter: blur(5px) saturate(180%);
  -webkit-backdrop-filter: blur(5px) saturate(180%);
  color: #1b4793 !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.10) !important;
}

/* Mini Event header text brighter & themed */
body.light-mode #miniEventOverlay .card > div:first-child {
  color: #fac92c !important; /* bright yellow accent */
}

body.light-mode {
  background-color: #cfe5cc; /* main light background */
  color: #1b4793; /* default text color */
}

/* Override dark radial gradient background */
body.light-mode #bg {
  background: #cfe5cc !important;
}

/* Effects OFF also disables blobs in light mode */
body.light-mode.no-bg-animations .blob {
  animation: none !important;
  background: none !important;
  opacity: 0 !important;
}

/* Achievements text */
body.light-mode .achievement {
  color: #fac92c;
}

/* Logs text */
body.light-mode #log {
  color: #0f336b !important; /* deep navy blue for strong contrast */
  font-weight: 500;          /* make slightly bolder */
}

/* Optional: highlight important log entries */
body.light-mode .mini-event-log {
  color: #1d6fa5 !important; /* brighter blue highlight */
  font-weight: 700;
}

/* Light mode for pop-up cards and info cards - glass style */
body.light-mode .card,
body.light-mode .essence-card,
body-light-mode .info-card { 
  background: rgba(255, 255, 255, 0.30) !important; /* glass transparency */
  backdrop-filter: blur(16px) saturate(160%);
  -webkit-backdrop-filter: blur(16px) saturate(160%);
  color: #1b4793 !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent navy border */
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.10) !important; /* softer shadow */
}

/* ensure the page background shorthand is overridden (not just background-color) */
html.light-mode,
body.light-mode {
  background: #cfe5cc !important;    /* full solid / base color */
  color: #1b4793 !important;
}

/* make the dark UI overlay much lighter in light mode (so it doesn't darken the page) */
body.light-mode .app::after {
  background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)) !important;
  /* if you prefer no overlay at all, use: background: none !important; */
}

/* If Effects toggle (no-bg-animations) is on, keep hiding blobs as before */
body.light-mode.no-bg-animations .blob {
  animation: none !important;
  background: none !important;
  opacity: 0 !important;
}

/* also make sure particles layer doesn't add dark speckle contrast in light mode */
body.light-mode .particles::before {
  background: transparent !important;
  opacity: 0.04 !important;
}

/* As a safety fallback: remove any pseudo-element dark backgrounds on scene card */
body.light-mode .scene-card::before {
  background: none !important;
  opacity: 0 !important;
}

/* Light mode blobs - sharper edges & more detail */
body.light-mode .blob {
  background: radial-gradient(circle at center,
              rgba(27, 71, 147, 0.90),
              rgba(54, 92, 62, 0.50)) !important;
  filter: blur(10px) saturate(140%); /* less blur = more edge definition */
  opacity: 0.50 !important;
  mix-blend-mode: screen;
  animation: blobMove 20s ease-in-out infinite, blobMorph 12s ease-in-out infinite;
  border-radius: 50%;
}

/* Shape morphing with more dramatic distortion */
@keyframes blobMorph {
  0%, 100% { border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%; }
  20% { border-radius: 35% 65% 55% 45% / 60% 40% 50% 50%; }
  40% { border-radius: 65% 35% 40% 60% / 45% 55% 60% 40%; }
  60% { border-radius: 50% 50% 65% 35% / 55% 45% 35% 65%; }
  80% { border-radius: 45% 55% 35% 65% / 65% 35% 45% 55%; }
}

/* Movement path stays the same, but adds a little scale pulse */
@keyframes blobMove {
  0%, 100% { transform: translate(0, 0) scale(1); }
  25% { transform: translate(30px, -40px) scale(1.15); }
  50% { transform: translate(-20px, 25px) scale(0.9); }
  75% { transform: translate(-35px, -15px) scale(1.05); }
}

/* Light mode glass effect - more transparent */
body.light-mode .card,
body.light-mode .essence-card
body.light-mode .info-card,
body.light-mode .scene-card,
body.light-mode .popup,
body.light-mode #queenPopup,
body.light-mode .persona-popup {
  background: rgba(255, 255, 255, 0.30) !important; /* more transparent */
  backdrop-filter: blur(16px) saturate(160%);
  -webkit-backdrop-filter: blur(16px) saturate(160%);
  color: #1b4793 !important;
  border: 1px solid rgba(255, 255, 255, 0.28) !important; /* lighter border */
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.10) !important;  /* softer shadow */
}

/* Keep gold border & glow for NPC Scenario cards in light mode */
body.light-mode .npc-scenario {
  border: 3px solid gold !important;
  box-shadow: 0 0 18px gold !important;
}

/* Essence labels darker & more legible */
body.light-mode #sideCard .label {
  color: #0f336b !important; /* deeper blue */
  font-weight: 600;
}

/* Essence bars brighter & higher contrast */
body.light-mode #sideCard .bar {
  background: rgba(27, 71, 147, 0.15) !important; /* pale blue track */
}

body.light-mode #sideCard .bar > i {
  box-shadow: none !important; /* remove dark shadows */
  filter: brightness(1.1); /* make filled portion pop */
}

/* Values more readable */
body.light-mode #sideCard .value {
  color: #0f336b !important;
  font-weight: 700;
}

/* Light mode toggle buttons - transparent when off, blue when on */
body.light-mode .toggle-btn {
  background: rgba(255, 255, 255, 0.30) !important; /* glassy transparent */
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent border */
  color: #0f336b !important;
}

/* ON state - blue background */
body.light-mode .toggle-btn.on {
  background: linear-gradient(180deg, #4a9ed4, #2f7bb5) !important;
  color: #fff !important;
  border: none !important;
}

/* Light mode buttons - glass effect */
body.light-mode .choice,
body.light-mode .card .choice,
body.light-mode .popup .choice,
body.light-mode .panel .choice {
  background: rgba(255, 255, 255, 0.10) !important; /* glass effect */
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  color: #0f336b !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent navy border */
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  transition: background 0.2s ease, border-color 0.2s ease;
}

/* Hover state - slightly brighter & border more visible */
body.light-mode .choice:hover,
body.light-mode .toggle-btn:hover,
body.light-mode .card .choice:hover,
body.light-mode .popup .choice:hover,
body.light-mode .panel .choice:hover {
  background: rgba(255, 255, 255, 0.40) !important; /* slightly brighter glass */
  border-color: rgba(15, 51, 107, 0.35) !important; /* slightly stronger */
}

/* Light mode dropdown with pastel border */
body.light-mode select.input {
  appearance: none !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;

  background: linear-gradient(180deg, #a7d8f0, #84c7b8) !important,
              url('data:image/svg+xml;utf8,<svg fill="%230f336b" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,7 15,7 10,12"/></svg>') no-repeat right 10px center !important;
  background-size: auto, 14px !important;

  color: #0f336b !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* light translucent navy border */
  border-radius: 6px;
  padding-right: 30px !important;
}

/* Light mode Essence bars - blue with outline */
body.light-mode #sideCard .bar {
  background: rgba(120, 170, 210, 0.25) !important; /* soft blue track */
  border: 1px solid rgba(15, 51, 107, 0.20) !important; /* translucent navy outline */
  border-radius: 12px;
}

body.light-mode #sideCard .bar > i {
  background: linear-gradient(180deg, #4a9ed4, #2f7bb5) !important; /* deeper blue fill */
  filter: brightness(1.05);
}

/* Dark mode - match dark theme dropdown */
body:not(.light-mode) select.input:focus {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
  color: #fff !important;
}

/* Ensure SPECIAL scenarios keep their green border in Light Mode */
body.light-mode .scene-card.special-scenario {
  border: 3px solid limegreen !important;
  box-shadow: 0 0 12px rgba(50,205,50,.7) !important;
}

/* (Optional) cover the older 'special' class name too */
body.light-mode .scene-card.special {
  border: 3px solid limegreen !important;
  box-shadow: 0 0 12px rgba(50,205,50,.7) !important;
}

/* --- Light Theme --- */
body.light-mode #playerName {
    background: linear-gradient(145deg, #fdf6e3, #f2e4c9);
    border: 2px solid #b88646;
    color: #4a2d15;
    box-shadow:
        0 0 6px rgba(184, 134, 70, 0.3),
        inset 0 0 3px rgba(255, 255, 255, 0.6);
}

body.light-mode #playerName::placeholder {
    color: rgba(74, 45, 21, 0.6);
}

body.light-mode #playerName:focus {
    border-color: #d9a860;
    box-shadow:
        0 0 10px rgba(217, 168, 96, 0.8),
        inset 0 0 4px rgba(255, 255, 255, 0.7);
}

body.light-mode #playerPlate {
    color: #4a2d15;
    text-shadow:
        0 0 3px rgba(255, 255, 255, 0.8),
        0 0 6px rgba(184, 134, 70, 0.3);
}

/* =====================
   LIGHT THEME (END)
   ===================== */
   
.fade-out {
    opacity: 0;
    transition: opacity 0.4s ease;
}

.fade-in {
    opacity: 1;
    transition: opacity 0.4s ease;
}

.scene-card.special-scenario {
    border: 3px solid #28a745; /* bright green */
    box-shadow: 0 0 12px rgba(40, 167, 69, 0.8);
}

#miniEventOverlay {
    opacity: 0;
    transition: opacity 0.4s ease;
}

#miniEventOverlay.fade-in {
    opacity: 1;
}

#miniEventOverlay.fade-out {
    opacity: 0;
}

#queenChoicesBox .choice {
    font-size: 15px;    /* smaller text */
    font-weight: 800;   /* lighter weight */
    padding: auto;  /* optional: make buttons smaller */
}

/* Align Logs and Achievements at the same top baseline */
#logCard, #achCard {
  margin-top: 0 !important;
  align-self: start;
}

/* Desktop: move Start button to the right */
@media (min-width: 1024px) {
  #startBtn {
    margin-left: auto; /* pushes it right in its flex row */
    display: block;
  }
}

/* Scenario text size */
#sceneCard {
  font-size: 13px; /* default mobile size */
  line-height: 1.2em;
}

@media (min-width: 768px) {
  #sceneCard {
    font-size: 18px;
  }
}

@media (min-width: 1024px) {
  #sceneCard {
    font-size: 20px;
  }
}

/* Disable hover movement on decision buttons for mobile */
@media (max-width: 767px) {
  .choice:hover {
    transform: none !important;
    box-shadow: none !important;
  }
}

@keyframes redBorderPulse {
  0% {
    border-color: rgba(255, 0, 0, 0.7);
    outline: 0px solid rgba(255, 0, 0, 0);
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.7);
  }
  50% {
    border-color: rgba(255, 0, 0, 1);
    outline: 3px solid rgba(255, 0, 0, 0.5); /* Fake border growth */
    box-shadow: 0 0 22px rgba(255, 0, 0, 1);
  }
  100% {
    border-color: rgba(255, 0, 0, 0.7);
    outline: 0px solid rgba(255, 0, 0, 0);
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.7);
  }
}

.bizarre-scenario {
  border: 0px solid red;
  animation: redBorderPulse 1.2s ease-in-out infinite;
}

body.light-mode .bizarre-scenario {
  border: 0px solid red !important;
  animation: redBorderPulse 1.2s ease-in-out infinite;
} 

/* Themed name input bar */
#playerName {
    background: linear-gradient(145deg, #2e1b12, #4a3026);
    border: 2px solid #caa472;
    color: #fce8d5;
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow:
        0 0 8px rgba(202, 164, 114, 0.6),
        inset 0 0 4px rgba(0,0,0,0.4);
    transition: all 0.25s ease-in-out;
}

#playerName::placeholder {
    color: rgba(252, 232, 213, 0.7);
    font-style: italic;
}

#playerName:focus {
    outline: none;
    border-color: #ffd7a0;
    box-shadow:
        0 0 12px rgba(255, 215, 160, 0.9),
        inset 0 0 6px rgba(0,0,0,0.5);
}

/* Make the name input fill the full row like the persona dropdown */
#playerName {
  width: 100% !important;
  display: block;
  box-sizing: border-box; /* includes padding/border in the 100% width */
  margin: 8px 0 12px;     /* some breathing room above/below */
  text-align: left;       /* keep typing natural; "justify" isn't useful in single-line inputs */
}

/* Light mode keeps the same full-width behavior automatically */
body.light-mode #playerName {
  width: 100% !important;
  display: block;
  box-sizing: border-box;
}

#playerPlate {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: #fce8d5;
    text-shadow:
        0 0 4px rgba(0, 0, 0, 0.6),
        0 0 8px rgba(202, 164, 114, 0.4);
    letter-spacing: 0.5px;
}

.scene-card {
  display: flex;
  flex-direction: column;
  justify-content: center; /* default: center */
  align-items: center;
  text-align: center;
  height: 100%;
  overflow: hidden;
  position: relative;
  padding: 1rem;
}

.scene-card-content {
  max-height: 100%;
  overflow-y: auto;
  width: 100%;
}

.scene-card.topAligned {
  justify-content: flex-start; /* push to top if overflow */
}

.choice.fullwidth {
  flex: 1 1 100%;
  width: 100%;
  text-align: center;
}


  </style> 
</head>
<body>
<div aria-hidden="true" class="bg-blobs">
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
<div class="blob b4"></div>
<div class="particles"></div>
</div>
<div class="app" id="appRoot">
<div class="container" id="mainContainer">
<div class="card">
<div class="header">
<div style="font-weight:800;font-size:20px">Yes, Sire. - V9.7.5</div>
<div style="text-align:right"><small id="yearDisplay">1512</small><div id="playerPlate" style="font-weight:700">The King</div></div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:6px;flex-wrap:nowrap;">

  <!-- LEFT COLUMN -->
  <div style="display:flex;flex-direction:column;gap:6px;flex:0 0 auto;">
    <select class="input" id="difficulty">
      <option value="easy">Easy (5 Essences)</option>
      <option value="medium">Medium (7 Essences)</option>
      <option value="hard">Hard (7 Essences, critical)</option>
    </select>
    <select class="input" id="theme">
     <option value="dark">Dark Theme</option>
     <option value="light">Light Theme</option>
    </select>
  </div>

  <!-- MIDDLE COLUMN -->
  <button class="choice" id="startBtn" style="flex:0 0 auto;">Start</button>

  <!-- RIGHT COLUMN -->
  <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-start;flex:0 0 auto;">
    <input id="hidePreview" type="checkbox" style="display:none"/>
    <input id="hideConsequences" type="checkbox" style="display:none"/>
    <button id="hidePreviewBtn" class="toggle-btn">Previews</button>
    <button id="hideEffectsBtn" class="toggle-btn">Effects</button>
  </div>     
</div>
<div class="scene" id="sceneArea" style="margin-top:12px">
<div class="scene-card" id="sceneCard">Press Start to begin your reign. Your decisions shape centuries.</div>
</div>
<div class="scene-meta">
<div><small>Decisions this decade: <span id="decCount">0</span>/6</small></div>
<div class="traits" id="traitsList"></div>
</div>
<div class="choices" id="choicesBox" style="display:none">
<button class="choice" id="acceptBtn">Accept</button>
<button class="choice secondary" id="declineBtn">Decline</button>
</div>
<!-- V9.7.5: Custom Queen decision tabs -->
<div class="choices" id="queenChoicesBox" style="display:none">
  <button class="choice" id="queenAgreeBtn">Support Her Plan</button>
  <button class="choice secondary" id="queenRefuseBtn">Politely Decline</button>
</div>
<div class="footer-small">Tip: Hover/hold choices buttons to preview which essences will be affected (if previews enabled).</div>
</div>

<!-- Card 1: Essences & Status -->
<div class="card" id="sideCard">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700">Essences &amp; Status</div>
  </div>
  <div class="essences" id="essencesList"></div>
</div>

<!-- Card 2: Logs -->
<div class="card" id="logCard">
 <div style="font-weight:700">Log</div> 
  <div class="log" id="log"></div>
</div>

<!-- Card 3: Achievements -->
<div class="card" id="achCard">
  <div style="font-weight:700">Achievements</div>
  <div id="achList"></div>
  
</div>
</div>
</div>
<div class="overlay" id="nameOverlay" style="display:none">
<div class="card" style="max-width:520px;width:92%">
<div style="font-weight:700;margin-bottom:8px">Enter your name and pick a persona</div>
<input class="input" id="playerName" placeholder="The Monarch's name"/>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="choice" id="acceptName" style="flex:1">Start Reign</button>
<button class="choice secondary" id="randomize" style="flex:1">Random Persona</button>
</div>
<div class="hint" style="margin-top:8px">Pick a persona to get a starting trait.</div>
<div style="display:flex;gap:8px;margin-top:8px">
<select class="input" id="persona" style="width:100%">
<option value="none">-- Choose a persona --</option>
<option value="beloved">Beloved Ruler (Population+)</option>
<option value="iron">Iron Fist (Strength+)</option>
<option value="shrewd">Shrewd Economist (Money+)</option>
<option value="patron">Patron of Arts (Culture+)</option>
</select>
</div>
</div>
</div>
</div>
</div>
  <!-- V9.8: Mini Event Popup -->
<div class="overlay" id="miniEventOverlay" style="display:none;">
  <div class="card" style="max-width:520px;width:92%;text-align:center;">
    <div style="font-size:22px;font-weight:800;color:var(--accent-a);margin-bottom:12px;">
      ðŸ“¢ MINI EVENT ðŸ“¢
    </div>
    <div id="miniEventText" style="margin-bottom:12px;font-size:16px;"></div>
    <div id="miniEventEffects" style="margin-bottom:16px;"></div>
    <button class="choice" id="dismissMiniEvent" style="width:160px;">OK</button>
  </div>
</div>
<script>

  // DOM
document.addEventListener('DOMContentLoaded', function(){
 
 // Global/session flag
let suppressQueen = false;

// Wire up the ellipses button
const ellipsesBtn = document.querySelector('.ellipses-btn');
if (ellipsesBtn) {
  ellipsesBtn.addEventListener('click', () => {
    // Kill the Queen arc permanently
    state.queenArcActive = false;
    suppressQueen = true;  // in case other checks still use this

    // Immediately strip queen scenarios from the pool
    state.scenePool = state.scenePool.filter(s =>
      !(s && typeof s.id === 'string' && s.id.startsWith('q'))
    );

    // Log and move forward
    console.log("Ellipses button pressed â€” Queen arc suppressed permanently.");
    makeDecision(false); // act like a decline, moves to next scene
  });
}

const themeSelect = document.getElementById('theme');

themeSelect.addEventListener('change', () => {
  const isLight = themeSelect.value === 'light';
  // toggle class on both html and body for maximum CSS coverage
  document.documentElement.classList.toggle('light-mode', isLight);
  document.body.classList.toggle('light-mode', isLight);
});

  function resizeApp() {
  const baseWidth = 698;
  const baseHeight = 944;

  // Independent manual multipliers
  const manualWidthMultiplier = 0.9;   // narrower than default
  const manualHeightMultiplier = 1.1;  // taller than default
  
  const scaleX = (window.innerWidth / baseWidth) * manualWidthMultiplier;
  const scaleY = (window.innerHeight / baseHeight) * manualHeightMultiplier;

  document.documentElement.style.setProperty('--scale-x', scaleX);
  document.documentElement.style.setProperty('--scale-y', scaleY);
}

const hidePreviewBtn = document.getElementById('hidePreviewBtn');
const hideEffectsBtn = document.getElementById('hideEffectsBtn');
const hidePreviewCheckbox = document.getElementById('hidePreview');
const hideEffectsCheckbox = document.getElementById('hideConsequences');
// Ensure visual matches state at startup
hidePreviewBtn.classList.toggle('on', !hidePreviewCheckbox.checked);

// Force Previews ON by default
hidePreviewCheckbox.checked = false;
hidePreviewBtn.classList.add('on');       

// Default ON
hideEffectsCheckbox.checked = true;
hideEffectsBtn.classList.add('on');

hideEffectsBtn.addEventListener('click', () => {
  hideEffectsCheckbox.checked = !hideEffectsCheckbox.checked;
  hideEffectsBtn.classList.toggle('on', hideEffectsCheckbox.checked);

  if (hideEffectsCheckbox.checked) {
    enableBackgroundAnimations();
  } else {
    disableBackgroundAnimations();
  }
});

function disableBackgroundAnimations() {
  document.body.classList.add('no-bg-animations');
}

function enableBackgroundAnimations() {
  document.body.classList.remove('no-bg-animations');

  // Restore blob backgrounds
  document.querySelectorAll('.blob').forEach(blob => {
    blob.style.background = ''; // revert to CSS default
    blob.style.animation = '';  // revert to CSS default
    blob.style.opacity = '';    // revert to CSS default
  });

  // Restore particles
  const particlesBefore = document.querySelector('.particles::before');
  if (particlesBefore) {
    particlesBefore.style.background = '';
    particlesBefore.style.animation = '';
    particlesBefore.style.opacity = '';
  }

  // Restore sheen
  const sceneCardBefore = document.querySelector('.scene-card::before');
  if (sceneCardBefore) {
    sceneCardBefore.style.background = '';
    sceneCardBefore.style.animation = '';
    sceneCardBefore.style.opacity = '';
  }
}

// Make Effects button match Previews button width
hideEffectsBtn.style.width = `${hidePreviewBtn.offsetWidth}px`;

hidePreviewBtn.addEventListener('click', () => {
  // Flip the checkbox
  hidePreviewCheckbox.checked = !hidePreviewCheckbox.checked;
  // 'on' = previews ON = checkbox NOT checked
  hidePreviewBtn.classList.toggle('on', !hidePreviewCheckbox.checked);
});

  function highlightEssenceChange(key, change) {
  const barEl = document.querySelector(`.essence-bar[data-essence="${key}"]`);
  if (!barEl) return;

  // reset any previous animation state
  barEl.classList.remove('gain', 'loss', 'fadeout');
  void barEl.offsetWidth; // reflow to restart animation reliably

  // show overlay (green for +, red for -)
  barEl.classList.add(change > 0 ? 'gain' : 'loss');

  // hold it visible briefly, then fade the overlay only
  const SHOW_MS = 450;
  const FADE_MS = 800;  // must match CSS transition duration
  setTimeout(() => {
    barEl.classList.add('fadeout');
    // after fade completes, clean up classes
    setTimeout(() => {
      barEl.classList.remove('gain', 'loss', 'fadeout');
    }, FADE_MS);
  }, SHOW_MS);
}

// Enhanced Immortal King â€” single-file
(function(){
  // === Data pools (deduplicated + expanded) ===
    const REPEATING = [
  {id:'r01', type:'aid', text:'A sudden fever is spreading among the fishermen of Pinebarrow. Shall we send royal healers, herbs, and coin to help them recover?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r02', type:'security', text:'Armed bandits have been robbing merchants along Trundle Pass near Quarry End. Do you dispatch troops to clear the road and reassure traders?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}, {k:'Control',d:2}
  ]},
  {id:'r03', type:'culture', text:'Captain Ioan asks for funds to stage a grand festival in Cedarford to honor the realmâ€™s artisans. Shall we sponsor the event?', effects:[
    {k:'Culture',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r04', type:'harvest', text:'Heavy rains have ruined Willowmereâ€™s granaries. Shall we open the royal grain stores and sell at low cost to feed the poor?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r05', type:'nobles', text:'Nobles from Mossgate request gold to arm soldiers loyal to your crown. Shall we grant the funds to secure their loyalty?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r06', type:'religion', text:'The abbey of St. Edrin in Tarnmoor is falling into ruin. Shall we fund its repair, even if it angers religious reformers?', effects:[
    {k:'Religion',d:2}, {k:'Money',d:-2}, {k:'Culture',d:1}
  ]},
  {id:'r07', type:'trade', text:'Evershore merchants want lower harbor fees to attract foreign ships. Approve the cut to encourage more trade?', effects:[
    {k:'Money',d:2}, {k:'Control',d:-1}
  ]},
  {id:'r08', type:'festival', text:'The guilds in Crowâ€™s Hollow want to host a harvest fair. Shall we fund music, games, and feasts to lift the peopleâ€™s spirits?', effects:[
    {k:'Culture',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r09', type:'education', text:'A traveling scholar offers to teach weaving apprentices in Brightford. Shall we fund this skill-building program?', effects:[
    {k:'Education',d:2}, {k:'Money',d:-2}, {k:'Culture',d:1}
  ]},
  {id:'r10', type:'infrastructure', text:'A lightning strike destroyed the watchtower at Stoneford. Shall we rebuild it to ensure early warning against threats?', effects:[
    {k:'Control',d:2}, {k:'Strength',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r11', type:'infrastructure', text:'East Arborâ€™s grain shipments have been delayed by damaged roads. Shall we send workers to repair the routes?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r12', type:'census', text:'In Blackfen, unrest has grown over a disputed census count. Shall we send royal officials to resolve the matter?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-1}
  ]},
  {id:'r13', type:'education', text:'A master glassblower in Mistvale offers to train apprentices in his craft. Shall we provide the necessary funds?', effects:[
    {k:'Education',d:2}, {k:'Culture',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r14', type:'militia', text:'The local militia in Marenâ€™s Bay complain of broken weapons and late pay. Shall we rearm them to keep the borders safe?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r15', type:'diplomacy', text:'The lord of High Solway offers peace if we return disputed grazing land. Shall we agree to maintain harmony?', effects:[
    {k:'Population',d:1}, {k:'Strength',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r16', type:'famine', text:'Vallortâ€™s stores are empty after floods destroyed their harvest. Shall we send grain and aid to prevent starvation?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r17', type:'tax', text:'Small farmers near Kingswell had a poor season. Shall we grant them temporary tax relief?', effects:[
    {k:'Population',d:1}, {k:'Money',d:-1}, {k:'Control',d:1}
  ]},
  {id:'r18', type:'defense', text:'Scouts report a warband gathering beyond Lowgateâ€™s marshes. Shall we reinforce forward defenses?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r19', type:'art', text:'A mosaic artist from Westwyche offers to decorate the cathedral with bold new designs. Shall we commission the work?', effects:[
    {k:'Culture',d:2}, {k:'Religion',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r20', type:'education', text:'A traveling herbalist offers to teach locals rare medicinal skills in Harrowfield. Shall we fund her lessons?', effects:[
    {k:'Education',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r21', type:'trade', text:'Merchants in Sableford want harbor fee reductions to draw more foreign traders. Shall we agree?', effects:[
    {k:'Money',d:2}, {k:'Control',d:-1}
  ]},
  {id:'r22', type:'infrastructure', text:'A sudden landslide near Ravenscar blocked the only mountain pass. Shall we send crews to clear it quickly?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r23', type:'disease', text:'A fever is spreading through Thornfieldâ€™s narrow streets. Shall we enforce quarantines and send healers?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r24', type:'infrastructure', text:'The royal aqueduct to Cairnhall is in disrepair. Shall we allocate funds to restore the water supply?', effects:[
    {k:'Control',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r25', type:'navy', text:'Hearthglenâ€™s fishing boats are being attacked by raiders. Shall we fund a small naval escort?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
    {id:'r26', type:'innovation', text:'An inventor in Rowan Reach requests funds to test a new watermill design. Shall we approve the grant?', effects:[
    {k:'Education',d:1}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r27', type:'diplomacy', text:'The lord of Norhollow offers peace if we return grazing rights. Shall we accept to avoid conflict?', effects:[
    {k:'Population',d:1}, {k:'Strength',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r28', type:'health', text:'In Port Rielle, poor sanitation is spreading illness. Shall we send doctors and funds to improve conditions?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r29', type:'agriculture', text:'Farmers near Stormcross request better irrigation. Shall we invest in new canals?', effects:[
    {k:'Control',d:1}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r30', type:'trade', text:'The weaversâ€™ guild at Goldhaven wants lower fees to attract new apprentices. Shall we approve?', effects:[
    {k:'Education',d:1}, {k:'Culture',d:1}, {k:'Money',d:1}
  ]},
  {id:'r31', type:'exploration', text:'A private company seeks royal backing to explore the western isles from Belfrost. Shall we support them for a share of profits?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
  {id:'r32', type:'infrastructure', text:'An engineer proposes reinforcing the hillside road above Bridgeford to prevent landslides. Shall we fund the work?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r33', type:'exploration', text:'A scholar from Orchardmere wishes to map uncharted marshlands for safer travel. Shall we fund the expedition?', effects:[
    {k:'Education',d:1}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r34', type:'navy', text:'Ashbridgeâ€™s fishing skiffs are attacked by coastal raiders. Shall we send a naval escort?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r35', type:'mining', text:'A mine collapse near Northwick has left workers without proper safety gear. Shall we send engineers and funds?', effects:[
    {k:'Population',d:1}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r36', type:'education', text:'Master smiths in Windmere offer to teach armor crafting if supplied with iron. Shall we provide it?', effects:[
    {k:'Education',d:1}, {k:'Strength',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r37', type:'espionage', text:'A courier near Redmarsh was found carrying suspicious foreign orders. Shall we investigate?', effects:[
    {k:'Control',d:2}, {k:'Strength',d:1}, {k:'Money',d:-1}
  ]},
  {id:'r38', type:'espionage', text:'A spy from Old Fen was caught with coded letters from a rival court. Shall we risk decoding them despite diplomatic tension?', effects:[
    {k:'Control',d:2}, {k:'Strength',d:1}, {k:'Money',d:-1}
  ]},
  {id:'r39', type:'nobles', text:'Nobles in Gildenford request funds to arm troops loyal to you. Shall we grant it to strengthen ties?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r40', type:'ceremonial', text:'Nobles in Port Lorian want funds to equip ceremonial guards. Shall we agree to maintain prestige?', effects:[
    {k:'Culture',d:1}, {k:'Strength',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r41', type:'militia', text:'The militia in Lyser have worn-out weapons and low morale. Shall we rearm and pay them?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r42', type:'navy', text:'Eastmarchâ€™s ships are under attack by raiders. Shall we build small escorts to protect them?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r43', type:'trade', text:'Silverpeak traders request a monopoly on river transport in exchange for tolls. Shall we grant it?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
  {id:'r44', type:'trade', text:'Ironford merchants request exclusive rights to timber trade along the river. Shall we approve?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
  {id:'r45', type:'mining', text:'Stonehaven miners need safer tools after a collapse. Shall we fund improvements?', effects:[
    {k:'Population',d:1}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r46', type:'tax', text:'Pinebarrowâ€™s farmers want temporary tax relief after a poor harvest. Shall we grant it?', effects:[
    {k:'Population',d:1}, {k:'Money',d:-1}, {k:'Control',d:1}
  ]},
  {id:'r47', type:'agriculture', text:'Landholders near Quarry End ask for new canals to water orchards. Shall we fund the works?', effects:[
    {k:'Control',d:1}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r48', type:'infrastructure', text:'A collapsed market hall roof in Cedarford has left traders without shelter. Shall we rebuild it?', effects:[
    {k:'Control',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r49', type:'infrastructure', text:'Willowmereâ€™s main bridge is gone after a flood. Shall we rebuild it quickly?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r50', type:'economy', text:'The mintmaster in Mossgate suggests re-coining silver for purity. Shall we fund the reform to restore trust?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
    {id:'r51', type:'archives', text:'Archivists in Tarnmoor have found old land charters. Shall we fund their cataloging to settle disputes?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r52', type:'health', text:'A fever strikes Evershoreâ€™s fishing villages. Shall we send healers, medicine, and food?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r53', type:'security', text:'Bandits have been raiding merchants along Trundle Pass near Crowâ€™s Hollow. Shall we send a patrol?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r54', type:'culture', text:'Bishop Marlow in Brightford requests funds for a grand pageant honoring artisans. Shall we approve?', effects:[
    {k:'Culture',d:2}, {k:'Religion',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r55', type:'famine', text:'Floods have destroyed Lakesendâ€™s food stores. Shall we release grain from the royal reserves?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r56', type:'nobles', text:'Nobles in East Arbor request gold to arm troops loyal to you. Shall we grant it?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r57', type:'religion', text:'The abbey of St. Edrin in Blackfen needs urgent repairs. Shall we fund the restoration?', effects:[
    {k:'Religion',d:2}, {k:'Money',d:-2}, {k:'Culture',d:1}
  ]},
  {id:'r58', type:'trade', text:'Vale of Orrin merchants want reduced harbor fees to attract foreign trade. Shall we approve?', effects:[
    {k:'Money',d:2}, {k:'Control',d:-1}
  ]},
  {id:'r59', type:'festival', text:'The guilds in Marenâ€™s Bay wish to host a harvest festival. Shall we sponsor it?', effects:[
    {k:'Culture',d:2}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r60', type:'education', text:'A scholar offers to train weaving apprentices in High Solway. Shall we fund him?', effects:[
    {k:'Education',d:2}, {k:'Culture',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r61', type:'infrastructure', text:'A fire destroyed Vallortâ€™s town hall. Shall we rebuild it to restore governance?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r62', type:'trade', text:'Kingswell merchants request reduced harbor fees to attract traders. Shall we grant it?', effects:[
    {k:'Money',d:2}, {k:'Control',d:-1}
  ]},
  {id:'r63', type:'census', text:'Lowgateâ€™s population count is disputed. Shall we send royal census-takers to settle it?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-1}
  ]},
  {id:'r64', type:'education', text:'A traveling scholar offers to teach weaving in Westwyche. Shall we fund the program?', effects:[
    {k:'Education',d:2}, {k:'Culture',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r65', type:'militia', text:'Harrowfieldâ€™s militia complain of poor pay and worn weapons. Shall we rearm them?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r66', type:'diplomacy', text:'The lord of Sableford offers peace if grazing rights are returned. Shall we accept?', effects:[
    {k:'Population',d:1}, {k:'Strength',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r67', type:'famine', text:'Floods have ruined Ravenscarâ€™s harvest. Shall we send grain and aid?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r68', type:'tax', text:'Thornfieldâ€™s farmers had a poor season. Shall we grant temporary tax relief?', effects:[
    {k:'Population',d:1}, {k:'Money',d:-1}, {k:'Control',d:1}
  ]},
  {id:'r69', type:'defense', text:'Raider activity is rising near Cairnhall. Shall we reinforce defenses?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r70', type:'art', text:'An artist in Hearthglen offers to decorate the cathedral with a bold design. Shall we approve?', effects:[
    {k:'Culture',d:2}, {k:'Religion',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r71', type:'cartography', text:'A master cartographer in Rowan Reach offers to chart dangerous coastal waters. Shall we sponsor his work?', effects:[
    {k:'Education',d:1}, {k:'Control',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r72', type:'trade', text:'Norhollow merchants want lower harbor fees to attract trade. Shall we grant it?', effects:[
    {k:'Money',d:2}, {k:'Control',d:-1}
  ]},
  {id:'r73', type:'defense', text:'Raiders are gathering near Port Rielle. Shall we strengthen defenses?', effects:[
    {k:'Strength',d:2}, {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r74', type:'health', text:'Illness is spreading in Stormcrossâ€™s backstreets. Shall we enforce quarantines and send healers?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r75', type:'infrastructure', text:'A collapsed stone bridge to Goldhaven has halted commerce. Shall we repair it at once?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
    {id:'r76', type:'navy', text:'Belfrostâ€™s ships are being attacked by raiders. Shall we fund escorts?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r77', type:'education', text:'A scholar in Bridgeford offers weaving apprenticeships. Shall we fund them?', effects:[
    {k:'Education',d:2}, {k:'Culture',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r78', type:'diplomacy', text:'The lord of Orchardmere offers peace if grazing rights are returned. Shall we agree?', effects:[
    {k:'Population',d:1}, {k:'Strength',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r79', type:'health', text:'Ashbridge faces a health crisis due to poor sanitation. Shall we send doctors and funds?', effects:[
    {k:'Population',d:2}, {k:'Money',d:-2}, {k:'Control',d:1}
  ]},
  {id:'r80', type:'agriculture', text:'Farmers near Northwick request better irrigation. Shall we invest?', effects:[
    {k:'Control',d:1}, {k:'Population',d:1}, {k:'Money',d:-2}
  ]},
  {id:'r81', type:'trade', text:'Windmereâ€™s weaversâ€™ guild wants lower fees for apprentices. Shall we grant it?', effects:[
    {k:'Education',d:1}, {k:'Culture',d:1}, {k:'Money',d:1}
  ]},
  {id:'r82', type:'exploration', text:'A company from Redmarsh seeks royal backing to explore western isles. Shall we invest?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
  {id:'r83', type:'infrastructure', text:'An engineer wants to strengthen the hillside road above Old Fen. Shall we fund him?', effects:[
    {k:'Control',d:2}, {k:'Money',d:-2}
  ]},
  {id:'r84', type:'exploration', text:'A company from Gildenford seeks a charter to explore western isles. Shall we approve?', effects:[
    {k:'Money',d:2}, {k:'Control',d:1}
  ]},
  {id:'r85', type:'navy', text:'Port Lorianâ€™s fishing boats are under attack by raiders. Shall we send naval escorts?', effects:[
    {k:'Strength',d:2}, {k:'Money',d:-2}
  ]}
];
  const SPECIAL = [
  // -------------------- 1512â€“1532 --------------------
  {id:'s01', decade:1, text:'Ferdinand Magellan offers to sail under your banner to find a western sea route to the spice islands. Will you fund his voyage despite the risk of losing ships and men to the unknown seas?', effects:[
    {k:'Money', d:-4}, {k:'Culture', d:3}, {k:'Education', d:2}, {k:'Strength', d:1}
  ]},
  {id:'s02', decade:1, text:'Leonardo da Vinciâ€™s final works arrive in your court. Will you purchase and preserve them for future generations, or let them be sold abroad to wealthy rivals?', effects:[
    {k:'Culture', d:4}, {k:'Money', d:-3}, {k:'Education', d:2}
  ]},
  {id:'s03', decade:1, text:'Reports from the New World speak of gold and fertile land. Will you authorize an expedition to claim territory in your name, or focus resources on your home provinces?', effects:[
    {k:'Money', d:-3}, {k:'Strength', d:2}, {k:'Culture', d:2}, {k:'Population', d:2}
  ]},
  {id:'s04', decade:1, text:'The printing press spreads quickly across Europe. Will you establish royal presses to standardize laws and religious texts, or leave printing to private merchants?', effects:[
    {k:'Education', d:4}, {k:'Control', d:3}, {k:'Religion', d:2}, {k:'Money', d:-2}
  ]},

  // -------------------- 1532â€“1552 --------------------
  {id:'s05', decade:2, text:'Conquistadors return from distant lands with treasures and tales of mighty empires. Will you send more expeditions to claim glory, or restrain to avoid costly wars?', effects:[
    {k:'Money', d:3}, {k:'Strength', d:2}, {k:'Culture', d:2}, {k:'Population', d:1}
  ]},
  {id:'s06', decade:2, text:'Michelangelo unveils the Last Judgment in the Sistine Chapel. Will you commission your own grand work to rival Romeâ€™s, or focus on military readiness instead?', effects:[
    {k:'Culture', d:4}, {k:'Money', d:-3}, {k:'Strength', d:-1}
  ]},
  {id:'s07', decade:2, text:'A surge of Protestant reformers challenge the authority of the church. Will you support reform to gain popular favor, or defend the old order to maintain unity?', effects:[
    {k:'Religion', d:-3}, {k:'Control', d:-2}, {k:'Culture', d:2}, {k:'Population', d:1}
  ]},
  {id:'s08', decade:2, text:'Cartographers request funds to map newly discovered coasts. Will you invest to secure navigational dominance, or leave exploration to private ventures?', effects:[
    {k:'Education', d:3}, {k:'Control', d:2}, {k:'Money', d:-2}
  ]},

  // -------------------- 1552â€“1572 --------------------
  {id:'s09', decade:3, text:'Tycho Brahe requests patronage to improve astronomical instruments. Will you fund his research to advance navigation, or invest in fortifications instead?', effects:[
    {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}, {k:'Control', d:1}
  ]},
  {id:'s10', decade:3, text:'Rumors spread of vast silver mines in the mountains overseas. Will you claim them for the crown, or focus on stabilizing domestic production?', effects:[
    {k:'Money', d:4}, {k:'Control', d:2}, {k:'Strength', d:1}, {k:'Population', d:1}
  ]},
  {id:'s11', decade:3, text:'The Council of Trent reaffirms traditional doctrine against Protestant reformers. Will you enforce its decrees strictly, or adopt a tolerant approach to faith?', effects:[
    {k:'Religion', d:3}, {k:'Control', d:2}, {k:'Culture', d:-1}
  ]},
  {id:'s12', decade:3, text:'Shipbuilders propose a new class of galleons for both trade and war. Will you approve the design and construction, or maintain your current fleet?', effects:[
    {k:'Strength', d:3}, {k:'Money', d:-3}, {k:'Control', d:1}
  ]},

  // -------------------- 1572â€“1592 --------------------
  {id:'s13', decade:4, text:'Sir Francis Drake offers to raid rival treasure fleets on your behalf. Will you grant him commission, or refuse to avoid open conflict?', effects:[
    {k:'Money', d:3}, {k:'Strength', d:2}, {k:'Control', d:-2}, {k:'Culture', d:1}
  ]},
  {id:'s14', decade:4, text:'William Shakespeareâ€™s plays gain immense popularity. Will you sponsor a theater to promote culture, or dismiss it as frivolous entertainment?', effects:[
    {k:'Culture', d:4}, {k:'Money', d:-2}, {k:'Education', d:1}
  ]},
  {id:'s15', decade:4, text:'A major port city in your realm suffers from plague. Will you quarantine and rebuild, or let commerce resume quickly despite the risk?', effects:[
    {k:'Population', d:-2}, {k:'Money', d:-2}, {k:'Control', d:1}
  ]},
  {id:'s16', decade:4, text:'Mathematicians request royal patronage to compile advanced navigation tables. Will you finance their work, or focus on immediate military spending?', effects:[
    {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}
  ]},

  // -------------------- 1592â€“1612 --------------------
  {id:'s17', decade:5, text:'Galileo Galilei offers to demonstrate his improved telescope. Will you fund his research, or ignore it to avoid controversy with religious authorities?', effects:[
    {k:'Education', d:4}, {k:'Culture', d:2}, {k:'Money', d:-2}, {k:'Religion', d:-1}
  ]},
  {id:'s18', decade:5, text:'The first globe-spanning trade routes become viable. Will you invest in establishing your own, or keep focus on regional commerce?', effects:[
    {k:'Money', d:3}, {k:'Culture', d:2}, {k:'Control', d:2}
  ]},
  {id:'s19', decade:5, text:'Jesuit missionaries request funding to spread influence abroad. Will you approve their mission, or concentrate resources at home?', effects:[
    {k:'Religion', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}
  ]},
  {id:'s20', decade:5, text:'An inventor presents an early mechanical calculator. Will you sponsor further development, or dismiss it as impractical?', effects:[
    {k:'Education', d:3}, {k:'Money', d:-1}, {k:'Culture', d:1}
  ]},
  
  // -------------------- 1612â€“1632 --------------------
{id:'s21', decade:6, text:'Johannes Kepler requests royal patronage to publish his laws of planetary motion. Will you fund his research or keep such knowledge under wraps to maintain religious authority?', effects:[
  {k:'Education', d:4}, {k:'Culture', d:2}, {k:'Money', d:-2}, {k:'Religion', d:-1}
]},
{id:'s22', decade:6, text:'Coffee from the East becomes a fashionable drink. Will you establish royal coffee houses to foster trade and culture, or dismiss it as a passing fad?', effects:[
  {k:'Culture', d:2}, {k:'Money', d:2}, {k:'Population', d:1}
]},
{id:'s23', decade:6, text:'The Thirty Yearsâ€™ War begins to engulf the continent. Will you intervene militarily to defend your allies, or remain neutral to preserve resources?', effects:[
  {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}, {k:'Population', d:-1}
]},
{id:'s24', decade:6, text:'Royal architects propose a grand palace to display your power. Will you commission it now, or delay construction for more pressing needs?', effects:[
  {k:'Culture', d:3}, {k:'Control', d:2}, {k:'Money', d:-4}
]},

// -------------------- 1632â€“1652 --------------------
{id:'s25', decade:7, text:'Rene Descartes offers to dedicate his philosophical works to your court. Will you support his ideas of reason and science, or reject them to uphold tradition?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Religion', d:-1}
]},
{id:'s26', decade:7, text:'A plague outbreak threatens your largest trade hub. Will you fund quarantines and hospitals, or keep trade flowing to avoid economic collapse?', effects:[
  {k:'Population', d:-2}, {k:'Money', d:-3}, {k:'Control', d:2}
]},
{id:'s27', decade:7, text:'A new musket design promises greater battlefield efficiency. Will you equip your armies, or stick with proven arms to avoid costly re-training?', effects:[
  {k:'Strength', d:3}, {k:'Money', d:-3}, {k:'Control', d:1}
]},
{id:'s28', decade:7, text:'Colonial governors report unrest and demand more autonomy. Will you grant concessions, or reinforce control from the capital?', effects:[
  {k:'Control', d:3}, {k:'Strength', d:2}, {k:'Culture', d:-1}
]},

// -------------------- 1652â€“1672 --------------------
{id:'s29', decade:8, text:'Isaac Newton presents his groundbreaking theories of motion and gravity. Will you sponsor his continued work, or decline to fund these abstract studies?', effects:[
  {k:'Education', d:5}, {k:'Culture', d:3}, {k:'Money', d:-2}
]},
{id:'s30', decade:8, text:'The Royal Society forms to advance scientific exchange. Will you become its patron, or focus on military innovation instead?', effects:[
  {k:'Education', d:4}, {k:'Culture', d:2}, {k:'Strength', d:-1}, {k:'Money', d:-2}
]},
{id:'s31', decade:8, text:'Dutch traders propose a joint venture in lucrative spice trade. Will you invest heavily, or let private merchants take the risk?', effects:[
  {k:'Money', d:4}, {k:'Culture', d:2}, {k:'Control', d:1}
]},
{id:'s32', decade:8, text:'A massive fire devastates a key city. Will you rebuild with improved planning, or quickly restore what was lost to save funds?', effects:[
  {k:'Population', d:2}, {k:'Culture', d:2}, {k:'Money', d:-3}, {k:'Control', d:1}
]},

// -------------------- 1672â€“1692 --------------------
{id:'s33', decade:9, text:'John Locke publishes works on government and liberty. Will you encourage these ideas to gain public support, or suppress them to maintain control?', effects:[
  {k:'Education', d:3}, {k:'Control', d:-2}, {k:'Culture', d:2}, {k:'Population', d:1}
]},
{id:'s34', decade:9, text:'Naval officers propose establishing a permanent standing navy. Will you approve the budget, or keep a smaller force to save gold?', effects:[
  {k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-4}
]},
{id:'s35', decade:9, text:'The opera gains popularity among nobility. Will you sponsor royal performances, or invest in more practical endeavors?', effects:[
  {k:'Culture', d:3}, {k:'Money', d:-2}
]},
{id:'s36', decade:9, text:'Merchants request exclusive rights to colonial resources. Will you grant the monopoly, or keep trade open to all?', effects:[
  {k:'Money', d:3}, {k:'Control', d:2}, {k:'Population', d:-1}
]},

// -------------------- 1692â€“1712 --------------------
{id:'s37', decade:10, text:'Gottfried Leibniz offers to bring his calculating machines to your court. Will you invest in this technology, or deem it unnecessary?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}
]},
{id:'s38', decade:10, text:'The War of Spanish Succession looms. Will you enter the conflict to secure influence, or remain neutral to protect your realm?', effects:[
  {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}, {k:'Population', d:-1}
]},
{id:'s39', decade:10, text:'Public coffee houses become hotbeds of political discussion. Will you tolerate them for cultural growth, or suppress them to avoid dissent?', effects:[
  {k:'Culture', d:2}, {k:'Control', d:-1}, {k:'Population', d:1}
]},
{id:'s40', decade:10, text:'Artisans request funding to produce fine porcelain to rival the East. Will you support the industry, or let merchants import it instead?', effects:[
  {k:'Culture', d:3}, {k:'Money', d:-2}, {k:'Population', d:1}
]},

// -------------------- 1712â€“1732 --------------------
{id:'s41', decade:11, text:'Voltaire seeks sanctuary and patronage after criticizing foreign rulers. Will you welcome him to your court, or refuse to avoid diplomatic tension?', effects:[
  {k:'Culture', d:3}, {k:'Education', d:2}, {k:'Control', d:-1}
]},
{id:'s42', decade:11, text:'Merchants propose the creation of a central bank. Will you approve to stabilize currency, or keep royal control over coinage?', effects:[
  {k:'Money', d:3}, {k:'Control', d:2}, {k:'Culture', d:1}
]},
{id:'s43', decade:11, text:'Engineers present plans for a major canal to connect trade routes. Will you fund the project, or invest in roads instead?', effects:[
  {k:'Control', d:3}, {k:'Money', d:-4}, {k:'Population', d:2}
]},
{id:'s44', decade:11, text:'Smallpox inoculation is proposed by court physicians. Will you support the trials, or ban the practice as dangerous?', effects:[
  {k:'Population', d:3}, {k:'Education', d:2}, {k:'Religion', d:-1}
]},

// -------------------- 1732â€“1752 --------------------
{id:'s45', decade:12, text:'Benjamin Franklin offers to share his experiments on electricity. Will you fund his work, or see it as mere curiosity?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}
]},
{id:'s46', decade:12, text:'A rival empireâ€™s navy grows alarmingly strong. Will you launch a shipbuilding program to match them, or focus on diplomacy?', effects:[
  {k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-3}
]},
{id:'s47', decade:12, text:'Naturalists request funding for an expedition to catalog distant lands. Will you sponsor them, or dismiss the venture as frivolous?', effects:[
  {k:'Culture', d:2}, {k:'Education', d:2}, {k:'Money', d:-2}
]},
{id:'s48', decade:12, text:'Merchants propose standardized weights and measures to ease trade. Will you implement the reform, or leave local systems in place?', effects:[
  {k:'Control', d:3}, {k:'Money', d:2}, {k:'Education', d:1}
]},

// -------------------- 1752â€“1772 --------------------
{id:'s49', decade:13, text:'James Watt demonstrates an improved steam engine. Will you invest in its development, or stick to traditional power sources?', effects:[
  {k:'Education', d:3}, {k:'Strength', d:2}, {k:'Money', d:-3}
]},
{id:'s50', decade:13, text:'Philosophers advocate for the abolition of slavery. Will you support the movement, or maintain the practice for economic gain?', effects:[
  {k:'Culture', d:3}, {k:'Control', d:-2}, {k:'Population', d:1}, {k:'Money', d:-2}
]},
{id:'s51', decade:13, text:'Agricultural innovators propose crop rotation reforms. Will you implement them, or keep traditional methods?', effects:[
  {k:'Population', d:3}, {k:'Education', d:2}, {k:'Money', d:-2}
]},
{id:'s52', decade:13, text:'A surge in political pamphlets sparks unrest. Will you censor publications, or permit open debate?', effects:[
  {k:'Control', d:-2}, {k:'Culture', d:2}, {k:'Education', d:1}
]},

// -------------------- 1772â€“1792 --------------------
{id:'s53', decade:14, text:'American colonies demand independence from foreign rule. Will you support their cause for liberty, or side with the established power?', effects:[
  {k:'Control', d:-3}, {k:'Culture', d:2}, {k:'Strength', d:-2}
]},
{id:'s54', decade:14, text:'Captain James Cook offers to chart unknown oceans. Will you fund his voyages, or allocate resources elsewhere?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}
]},
{id:'s55', decade:14, text:'A political revolution abroad seeks your aid. Will you send troops and supplies, or stay out to avoid entanglement?', effects:[
  {k:'Strength', d:3}, {k:'Money', d:-2}, {k:'Control', d:1}
]},
{id:'s56', decade:14, text:'Debates arise over adopting a formal declaration of human rights. Will you endorse it, or reject it to preserve the monarchyâ€™s authority?', effects:[
  {k:'Culture', d:3}, {k:'Control', d:-3}, {k:'Education', d:2}
]},

// -------------------- 1792â€“1812 --------------------
{id:'s57', decade:15, text:'Napoleon Bonaparte rises to prominence. Will you ally with him for mutual gain, or oppose his ambitions?', effects:[
  {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}
]},
{id:'s58', decade:15, text:'The metric system is proposed to standardize measures. Will you adopt it, or keep traditional units?', effects:[
  {k:'Education', d:2}, {k:'Control', d:2}, {k:'Money', d:1}
]},
{id:'s59', decade:15, text:'Steam-powered ships promise faster trade routes. Will you invest, or stick to sail until proven safe?', effects:[
  {k:'Strength', d:2}, {k:'Money', d:-3}, {k:'Culture', d:1}
]},
{id:'s60', decade:15, text:'A devastating famine strikes your provinces. Will you open royal granaries to feed the people, or sell reserves to fund the army?', effects:[
  {k:'Population', d:3}, {k:'Control', d:1}, {k:'Money', d:-3}
]},

// -------------------- 1812â€“1832 --------------------
{id:'s61', decade:16, text:'The Industrial Revolution accelerates. Will you fund factories in your cities, or restrict them to protect traditional craftsmen?', effects:[
  {k:'Money', d:4}, {k:'Population', d:2}, {k:'Culture', d:-1}
]},
{id:'s62', decade:16, text:'Charles Babbage proposes his mechanical computing engine. Will you invest in its construction, or deem it impractical?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:1}, {k:'Money', d:-3}
]},
{id:'s63', decade:16, text:'Railway technology emerges abroad. Will you build a network now, or wait until the costs decline?', effects:[
  {k:'Control', d:2}, {k:'Money', d:-4}, {k:'Population', d:3}
]},
{id:'s64', decade:16, text:'Romantic poets gain influence among the youth. Will you sponsor their works, or restrict their reach to maintain discipline?', effects:[
  {k:'Culture', d:3}, {k:'Control', d:-1}
]},

// -------------------- 1832â€“1852 --------------------
{id:'s65', decade:17, text:'Telegraph networks are being built in neighboring realms. Will you invest in connecting your kingdom, or rely on existing couriers?', effects:[
  {k:'Education', d:2}, {k:'Control', d:3}, {k:'Money', d:-3}
]},
{id:'s66', decade:17, text:'Charles Darwin begins work on his theories of evolution. Will you support his studies, or suppress them as heretical?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Religion', d:-2}
]},
{id:'s67', decade:17, text:'Mass protests erupt demanding voting reforms. Will you grant concessions, or deploy the army to restore order?', effects:[
  {k:'Control', d:-2}, {k:'Population', d:2}, {k:'Strength', d:1}
]},
{id:'s68', decade:17, text:'A deadly cholera outbreak spreads rapidly. Will you fund sanitation projects, or leave it to local authorities?', effects:[
  {k:'Population', d:3}, {k:'Money', d:-3}, {k:'Education', d:1}
]},

// -------------------- 1852â€“1872 --------------------
{id:'s69', decade:18, text:'Alexander Graham Bell seeks support to develop the telephone. Will you finance his invention, or dismiss it as fanciful?', effects:[
  {k:'Education', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}
]},
{id:'s70', decade:18, text:'Workers organize to demand shorter hours. Will you legislate reforms, or side with industrialists to preserve profits?', effects:[
  {k:'Population', d:2}, {k:'Control', d:-1}, {k:'Money', d:-2}
]},
{id:'s71', decade:18, text:'A railway tycoon offers to link your ports with inland mines. Will you back the project, or let private investors handle it?', effects:[
  {k:'Money', d:3}, {k:'Control', d:2}, {k:'Population', d:1}
]},
{id:'s72', decade:18, text:'Photography becomes a popular medium. Will you fund a royal archive of images, or consider it a passing novelty?', effects:[
  {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-1}
]},

// -------------------- 1872â€“1892 --------------------
{id:'s73', decade:19, text:'Thomas Edison offers to light your capital with electric lamps. Will you invest in the project, or stick to gas lighting?', effects:[
  {k:'Education', d:2}, {k:'Control', d:2}, {k:'Money', d:-3}
]},
{id:'s74', decade:19, text:'The telephone spreads rapidly abroad. Will you nationalize the network, or leave it in private hands?', effects:[
  {k:'Control', d:3}, {k:'Money', d:2}, {k:'Culture', d:1}
]},
{id:'s75', decade:19, text:'An influenza epidemic sweeps through the realm. Will you close public gatherings, or let daily life continue unchanged?', effects:[
  {k:'Population', d:-2}, {k:'Control', d:1}
]},
{id:'s76', decade:19, text:'Foreign explorers request funding to reach the poles. Will you support them, or focus on domestic projects?', effects:[
  {k:'Culture', d:2}, {k:'Education', d:2}, {k:'Money', d:-2}
]},

// -------------------- 1892â€“1912 --------------------
{id:'s77', decade:20, text:'The Wright brothers request backing for their flying machine. Will you invest, or wait until the technology matures?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:1}, {k:'Money', d:-3}
]},
{id:'s78', decade:20, text:'A suffrage movement demands voting rights for women. Will you enact the reform, or resist to maintain tradition?', effects:[
  {k:'Control', d:-2}, {k:'Culture', d:2}, {k:'Population', d:1}
]},
{id:'s79', decade:20, text:'A massive earthquake devastates a coastal city. Will you send royal engineers for reconstruction, or leave it to local councils?', effects:[
  {k:'Population', d:3}, {k:'Control', d:1}, {k:'Money', d:-3}
]},
{id:'s80', decade:20, text:'Marconiâ€™s wireless telegraph promises global communication. Will you adopt it, or rely on existing telegraph lines?', effects:[
  {k:'Education', d:2}, {k:'Control', d:2}, {k:'Money', d:-2}
]},

// -------------------- 1912â€“1932 --------------------
{id:'s81', decade:21, text:'Albert Einstein offers to join your court as scientific advisor. Will you accept, or decline to avoid controversy?', effects:[
  {k:'Education', d:4}, {k:'Culture', d:2}, {k:'Money', d:-2}
]},
{id:'s82', decade:21, text:'War breaks out among major powers. Will you mobilize your forces, or stay neutral to preserve stability?', effects:[
  {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-4}, {k:'Population', d:-2}
]},
{id:'s83', decade:21, text:'A deadly influenza pandemic spreads. Will you impose quarantines and fund hospitals, or focus on economic recovery?', effects:[
  {k:'Population', d:3}, {k:'Money', d:-3}, {k:'Control', d:1}
]},
{id:'s84', decade:21, text:'A major industrial strike paralyzes key industries. Will you negotiate with workers, or deploy troops to break the strike?', effects:[
  {k:'Control', d:-2}, {k:'Population', d:2}, {k:'Strength', d:1}
]},

// -------------------- 1932â€“1952 --------------------
{id:'s85', decade:22, text:'Global economic depression cripples trade. Will you launch public works programs, or cut spending to balance the treasury?', effects:[
  {k:'Population', d:2}, {k:'Money', d:-4}, {k:'Control', d:1}
]},
{id:'s86', decade:22, text:'A charismatic foreign leader offers an alliance. Will you accept, or remain cautious?', effects:[
  {k:'Strength', d:2}, {k:'Control', d:1}, {k:'Money', d:-1}
]},
{id:'s87', decade:22, text:'Radar technology promises an edge in warfare. Will you invest in its development, or ignore it until proven effective?', effects:[
  {k:'Education', d:3}, {k:'Strength', d:2}, {k:'Money', d:-3}
]},
{id:'s88', decade:22, text:'Wartime propaganda boosts morale. Will you fund it, or focus resources on the front lines?', effects:[
  {k:'Culture', d:2}, {k:'Control', d:1}, {k:'Money', d:-1}
]},

// -------------------- 1952â€“1972 --------------------
{id:'s89', decade:23, text:'Space exploration becomes a new frontier. Will you launch a national program, or focus on earthly concerns?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-4}
]},
{id:'s90', decade:23, text:'A revolution erupts in a neighboring land. Will you intervene to protect your interests, or let events unfold?', effects:[
  {k:'Strength', d:2}, {k:'Control', d:1}, {k:'Money', d:-2}
]},
{id:'s91', decade:23, text:'Civil rights activists demand equal treatment for all citizens. Will you enact reforms, or resist change?', effects:[
  {k:'Culture', d:3}, {k:'Control', d:-2}, {k:'Population', d:1}
]},
{id:'s92', decade:23, text:'Television becomes a powerful medium. Will you fund a royal broadcasting service, or leave it to private enterprises?', effects:[
  {k:'Culture', d:2}, {k:'Control', d:1}, {k:'Money', d:-2}
]},

// -------------------- 1972â€“1992 --------------------
{id:'s93', decade:24, text:'Computers emerge as vital tools for governance. Will you modernize your administration, or keep traditional records?', effects:[
  {k:'Education', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}
]},
{id:'s94', decade:24, text:'The oil crisis threatens your economy. Will you invest in alternative energy, or double down on existing imports?', effects:[
  {k:'Money', d:-3}, {k:'Control', d:1}, {k:'Education', d:2}
]},
{id:'s95', decade:24, text:'Medical scientists propose mass vaccination programs. Will you approve funding, or limit it to the most vulnerable?', effects:[
  {k:'Population', d:3}, {k:'Education', d:1}, {k:'Money', d:-2}
]},
{id:'s96', decade:24, text:'Personal computers enter the market. Will you promote digital literacy, or let the trend grow without interference?', effects:[
  {k:'Education', d:2}, {k:'Culture', d:1}, {k:'Money', d:-1}
]},

// -------------------- 1992â€“2012 --------------------
{id:'s97', decade:25, text:'The internet connects the world. Will you invest in nationwide access, or restrict it to key institutions?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}
]},
{id:'s98', decade:25, text:'Climate change activists call for strict environmental laws. Will you pass sweeping reforms, or prioritize industry?', effects:[
  {k:'Population', d:1}, {k:'Culture', d:2}, {k:'Money', d:-2}
]},
{id:'s99', decade:25, text:'A financial crisis rocks global markets. Will you bail out key industries, or let them fail?', effects:[
  {k:'Money', d:-4}, {k:'Control', d:1}, {k:'Population', d:-1}
]},
{id:'s100', decade:25, text:'Mobile phones dominate communication. Will you create a royal telecom network, or leave it to private firms?', effects:[
  {k:'Control', d:2}, {k:'Money', d:2}, {k:'Culture', d:1}
]},

// -------------------- 2012â€“2032 (fictional future) --------------------
{id:'s101', decade:26, text:'Artificial intelligence promises to revolutionize governance. Will you adopt it to run parts of your administration, or keep humans in charge?', effects:[
  {k:'Education', d:3}, {k:'Control', d:3}, {k:'Money', d:-2}
]},
{id:'s102', decade:26, text:'Gene editing can eliminate hereditary diseases. Will you authorize widespread use, or limit it due to ethical concerns?', effects:[
  {k:'Population', d:3}, {k:'Education', d:2}, {k:'Religion', d:-1}
]},
{id:'s103', decade:26, text:'Global water shortages loom. Will you invest in desalination plants, or focus on conservation campaigns?', effects:[
  {k:'Population', d:2}, {k:'Money', d:-3}, {k:'Control', d:1}
]},
{id:'s104', decade:26, text:'Private companies plan colonization of Mars. Will you join the venture, or prioritize earthly needs?', effects:[
  {k:'Culture', d:2}, {k:'Education', d:3}, {k:'Money', d:-4}
]},

// -------------------- 2032â€“2052 (fictional future) --------------------
{id:'s105', decade:27, text:'Quantum computing breaks all encryption. Will you invest in secure systems, or accept the risks of open data?', effects:[
  {k:'Control', d:2}, {k:'Education', d:2}, {k:'Money', d:-3}
]},
{id:'s106', decade:27, text:'Synthetic food production can feed the entire population. Will you fund it, or protect traditional farming?', effects:[
  {k:'Population', d:3}, {k:'Money', d:-2}, {k:'Culture', d:-1}
]},
{id:'s107', decade:27, text:'Rising sea levels threaten coastal cities. Will you construct massive barriers, or relocate citizens inland?', effects:[
  {k:'Control', d:2}, {k:'Population', d:2}, {k:'Money', d:-4}
]},
{id:'s108', decade:27, text:'Neural interface technology allows direct brain-computer links. Will you regulate it, or embrace its potential?', effects:[
  {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}
]},

// -------------------- 2052â€“2072 (fictional future) --------------------
{id:'s109', decade:28, text:'Fusion power becomes commercially viable. Will you invest heavily to lead the energy market, or let others take the risk?', effects:[
  {k:'Education', d:3}, {k:'Money', d:4}, {k:'Control', d:2}
]},
{id:'s110', decade:28, text:'Global AI governance councils form. Will you join to shape policy, or keep your sovereignty untouched?', effects:[
  {k:'Control', d:2}, {k:'Culture', d:1}, {k:'Strength', d:1}
]},
{id:'s111', decade:28, text:'Bio-engineered soldiers are proposed for defense. Will you approve their deployment, or reject the idea on moral grounds?', effects:[
  {k:'Strength', d:4}, {k:'Control', d:2}, {k:'Religion', d:-1}
]},
{id:'s112', decade:28, text:'Undersea cities become possible through advanced engineering. Will you fund their construction, or focus on land development?', effects:[
  {k:'Population', d:3}, {k:'Culture', d:2}, {k:'Money', d:-5}
]},

// -------------------- 2072â€“2092 (fictional future) --------------------
{id:'s113', decade:29, text:'Climate restoration technology can reverse centuries of damage. Will you deploy it now, or wait for further testing?', effects:[
  {k:'Population', d:2}, {k:'Culture', d:2}, {k:'Money', d:-3}
]},
{id:'s114', decade:29, text:'First contact with alien life is established. Will you pursue peaceful cooperation, or prepare for defense?', effects:[
  {k:'Culture', d:3}, {k:'Strength', d:2}, {k:'Education', d:2}
]},
{id:'s115', decade:29, text:'Artificial superintelligence offers to advise your rule. Will you accept its counsel, or maintain human decision-making?', effects:[
  {k:'Control', d:3}, {k:'Education', d:3}, {k:'Money', d:-1}
]},
{id:'s116', decade:29, text:'Mass migration from uninhabitable regions strains resources. Will you welcome the refugees, or close your borders?', effects:[
  {k:'Population', d:3}, {k:'Culture', d:1}, {k:'Control', d:-2}
]},

<!--
// -------------------- 2092â€“2112 (fictional future) --------------------
{id:'s117', decade:30, text:'A rogue asteroid is detected on a collision course. Will you fund a planetary defense system, or trust in fate?', effects:[
  {k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-5}
]},
{id:'s118', decade:30, text:'Mind uploading becomes a reality. Will you offer immortality to your citizens, or restrict it to a select few?', effects:[
  {k:'Culture', d:2}, {k:'Population', d:2}, {k:'Education', d:2}
]},
{id:'s119', decade:30, text:'Global governance proposes uniting all armies under one banner. Will you join, or maintain your independent forces?', effects:[
  {k:'Strength', d:-2}, {k:'Control', d:-2}, {k:'Culture', d:1}
]},
{id:'s120', decade:30, text:'Terraforming technology allows habitable worlds beyond Earth. Will you lead colonization efforts, or preserve your focus on the homeworld?', effects:[
  {k:'Culture', d:3}, {k:'Population', d:3}, {k:'Money', d:-4}
]}
-->
];



// === V9.7.5: NPC Scenarios ===
// These are special decade-first-decision events tied to notable NPCs.
// For now, we start with "The Queen" arc.
const NPC_SCENARIOS = [
  { id: 'q01', npc: 'The Queen', text: 'The Queen proposes establishing a royal orphanage to shelter children of fallen soldiers. Shall we fund it?', effects:[
    {k:'Population', d:3}, {k:'Education', d:2}, {k:'Culture', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q02', npc: 'The Queen', text: 'The Queen wishes to sponsor a womenâ€™s weaving guild to strengthen the textile trade. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q03', npc: 'The Queen', text: 'The Queen suggests hosting a diplomatic banquet for neighboring rulers. Shall we allocate funds?', effects:[
    {k:'Culture', d:2}, {k:'Control', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q04', npc: 'The Queen', text: 'The Queen urges improved palace security after a recent scare. Approve her plan?', effects:[
    {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q05', npc: 'The Queen', text: 'The Queen proposes a charity fair to raise funds for the poor. Shall we support it?', effects:[
    {k:'Population', d:2}, {k:'Culture', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q06', npc: 'The Queen', text: 'The Queen wants to commission a portrait gallery honoring past monarchs. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q07', npc: 'The Queen', text: 'The Queen recommends sending relief ships to famine-struck isles. Approve?', effects:[
    {k:'Population', d:3}, {k:'Religion', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q08', npc: 'The Queen', text: 'The Queen proposes a new code of court etiquette. Approve?', effects:[
    {k:'Control', d:2}, {k:'Culture', d:1}, {k:'Education', d:1}
  ]},
  { id: 'q09', npc: 'The Queen', text: 'The Queen urges funding for a music academy in the capital. Approve?', effects:[
    {k:'Culture', d:3}, {k:'Education', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q10', npc: 'The Queen', text: 'The Queen seeks to improve palace gardens to host foreign dignitaries. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q11', npc: 'The Queen', text: 'The Queen proposes sending envoys to settle a border dispute peacefully. Approve?', effects:[
    {k:'Control', d:2}, {k:'Culture', d:1}, {k:'Strength', d:1}
  ]},
  { id: 'q12', npc: 'The Queen', text: 'The Queen wishes to open a royal school for gifted children. Approve?', effects:[
    {k:'Education', d:3}, {k:'Population', d:1}, {k:'Culture', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q13', npc: 'The Queen', text: 'The Queen asks for funds to restore a historic cathedral. Approve?', effects:[
    {k:'Religion', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q14', npc: 'The Queen', text: 'The Queen recommends sending herbalists to rural villages to improve health. Approve?', effects:[
    {k:'Population', d:2}, {k:'Religion', d:1}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q15', npc: 'The Queen', text: 'The Queen suggests creating a scholarship for talented village children. Approve?', effects:[
    {k:'Education', d:2}, {k:'Population', d:1}, {k:'Culture', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q16', npc: 'The Queen', text: 'The Queen wishes to commission a royal chronicle of your reign. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Control', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q17', npc: 'The Queen', text: 'The Queen urges expanding the city watch to keep peace. Approve?', effects:[
    {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Population', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q18', npc: 'The Queen', text: 'The Queen wants to create a guild for healers to standardize medicine. Approve?', effects:[
    {k:'Education', d:2}, {k:'Population', d:1}, {k:'Religion', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q19', npc: 'The Queen', text: 'The Queen proposes sending aid to an ally recovering from war. Approve?', effects:[
    {k:'Strength', d:1}, {k:'Control', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q20', npc: 'The Queen', text: 'The Queen asks for funds to sponsor a grand midwinter feast for the people. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},

  // Queen Immortality Arc

  { id: 'q21', npc: 'The Queen', text: "As the first decade of your reign draws to a close, the Queen gazes at her reflection, her features softened by age. 'My love,' she says, 'you will stand unchanging for centuries... but I will fade. I beg you â€” let us seek the Alchemist of Eternity, even if it takes decades.'", effects:[
    {k:'Culture', d:1}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q22', npc: 'The Queen', text: "Ten years have passed since the Queen began her search. Now, in the second decade, she returns with a fragment of hope â€” a dusty scroll pointing to the Alchemistâ€™s last known dwelling. But journeys into forgotten lands will drain the kingdomâ€™s wealth and test its peopleâ€™s loyalty.", effects:[
    {k:'Money', d:-3}, {k:'Strength', d:1}, {k:'Culture', d:1}
  ]},
  { id: 'q23', npc: 'The Queen', text: "Two decades of labor bear fruit. The Alchemist stands in the grand hall, promising the Queenâ€™s immortality. Yet, as the third decade wanes, rumors spread through the realm â€” strange eclipses, sickness among livestock, and whispers that the crown meddles with forbidden forces.", effects:[
    {k:'Religion', d:-2}, {k:'Culture', d:1}, {k:'Population', d:-1}
  ]},
  { id: 'q24', npc: 'The Queen', text: "The fourth decade finds the Queen changed â€” her hair streaked with silver, her gaze fixed on the Alchemistâ€™s work. 'One last ingredient remains,' he tells you, 'a portion of your eternal essence.' The Queenâ€™s voice trembles, but her eyes are steady. 'Will you give it to me?'", effects:[
    {k:'Religion', d:-1}, {k:'Strength', d:-1}, {k:'Money', d:-2}
  ]},
  { id: 'q25', npc: 'The Queen', text: "Half a century has passed since the Queen first spoke of her fear. Tonight, the fifth decade ends, and the ritual stands ready. The hall is lined with candles; the air hums with power. If you proceed, she may reign with you forever â€” or vanish into the shadows of history.", effects:[
    {k:'Culture', d:1}, {k:'Religion', d:-2}, {k:'Population', d:-1}
  ]}, 
  
  // Refusal of Counsels
  
  {
  id: 'q26',
  npc: 'The Queen',
  text: "'You have refused my counsel more than once,'<br><br>the Queen whispers, standing beneath the dim glow of dusk in the private gallery where they once danced without music. The air between them is heavy with years unspoken, and the palace walls seem to echo her ache.<br><br>'I do not come to argue, only to remember. Just one hour â€” let me know if your heart still reaches for mine beneath the weight of the crown. Or must I learn to love you from afar, as one loves a fading star?'", effects: [
    {k:'Money', d:-1}, {k:'Population', d:1}, {k:'Culture', d:2}, {k:'Control', d:-1}
  ],
  resultText: {
  accept: "The chamber falls silent but for your voices. What began as counsel drifts into laughter, and laughter into something softer â€” a warmth that neither crown nor duty could command. The Queenâ€™s eyes shine, not with triumph, but with the quiet relief of love remembered and returned. For a moment, the palace feels like home again.",
  decline: "Her smile falters, just enough to betray the hope she carried in. She bows with perfect grace, but the gesture feels colder now â€” rehearsed. As she turns, the echo of her footsteps lingers, stretching through the gallery like a memory that refuses to fade. The dusk deepens, and the distance between you grows."
  }},

  {
  id: 'q27',
  npc: 'The Queen',
  text: "Seasons pass after the galleryâ€™s silence. The Queen returns, her composure unshaken but her gaze unguarded. 'We have shared warmth, and yetâ€¦ no heir comes,' she admits, voice low as though the stones themselves might gossip. 'The kingdom needs more than memory. There are healers, scholars, even alchemists who claim hope where nature has denied us. Some paths are sacred, others perilous. Stillâ€”will you walk them with me?'",
  effects: [
    {k:'Population', d:2}, {k:'Control', d:2}, {k:'Money', d:-3}, {k:'Culture', d:1}, {k:'Religion', d:-2}, {k:'Education', d:2}
  ],
  resultText: {
    accept: "The palace opens its doors to strangers cloaked in incense and strange symbols. Nights are filled with whispers of remedies and rites. Though doubt lingers, the Queen moves with quiet determination, and hope flickers once more in the shadow of the throne.",
    decline: "The scrolls curl into ash, their promises lost to smoke. The Queen lowers her gaze, a brittle smile masking the ache beneath. 'Then the realm itself shall be our child,' she murmurs, her words heavy with resignation. Yet the silence between you feels heavier still."
  }},

  
{
  id: 'q28',
  npc: 'The Queen',
  text: (() => {
    // Always go through window.state safely
    window.state = window.state || {};

    if (!window.state.childGender) {
      const isGirl = Math.random() < 0.5;
      window.state.childGender = isGirl ? "daughter" : "son";
      window.state.childPronoun = isGirl ? "she" : "he";
      window.state.childPossessive = isGirl ? "her" : "his";
      window.state.childTitle = isGirl ? "Your Daughter" : "Your Son";
    }

    const child = window.state.childGender;
    const pronoun = window.state.childPossessive;

    return `The Queen stands before you, cradling your ${child} â€” a quiet miracle, a promise wrapped in soft breath and fragile warmth.<br><br>
    This is no longer just the realmâ€™s future, but yours. In ${pronoun} eyes, you see everything unspoken: the sacrifices, the longing, the hope that this moment might mend what history could not.<br><br>
    She offers the child to you, hands trembling slightly.<br><br>
    â€œWill you claim our ${child},â€ she asks, â€œnot by duty, but by love?â€<br><br>
    The chamber holds its breath. The crown feels lighter. The choice before you is no longer about power â€” itâ€™s about devotion, and the legacy only you can give.`;
  })(),
  effects: [
    { k: 'Population', d: 3 },
    { k: 'Money', d: -3 },
    { k: 'Control', d: 1 }
  ],
  resultText: {
    accept: () => {
      const child = window.state?.childGender || "child";
      return `You take your ${child} in your arms, the weight both delicate and immeasurable. The court erupts in celebration, and across the land, bells ring for the birth of the heir. For once, duty and love are indistinguishable â€” the realmâ€™s future, secured by your embrace.<br><br>
      <i>(A new bond beginsâ€¦)</i>`;
    },
    decline: () => {
      const child = window.state?.childGender || "child";
      return `You step back, the air colder for your distance. The Queen gathers your ${child} close, lips pressed to a trembling brow. Whispers bloom in the court like weeds: of a ruler without love, of an heir unclaimed. The realm has its future, but the bond between crown and heart may never heal.<br><br>...`;
    }
  },
  onAccept: () => {
    // âœ… Safe call to mini-game
    setTimeout(() => {
      if (typeof startChildMiniGame === "function") {
        startChildMiniGame();
      }
    }, 300);
  }
},
  
  {
  id: 'q29',
  npc: 'The Queen',
  text: "Nights grow longer, halls grow quieter. The Queen no longer walks the gardens, nor attends the court. Her laughter â€” once a rare, bright thing â€” has withered into silence.<br><br>\
She stands before you only once more, eyes hollow with grief too heavy for crowns or counsel.<br><br>\
'Once, I called this gift a blessing,' she whispers, touching the faint silver mark that lingers on her wrist â€” the seal of her immortality. 'But love spurned, devotion refusedâ€¦ has turned it into a curse I can no longer bear.'<br><br>\
Her hands tremble as she raises them, weaving the ancient signs. The air shudders with power, not of life preserved, but of life released.",

  // No essence effects â€” it's a pure story event
  effects: [],

  // Only one button
  singleChoice: {
    label: "...",
    onChoose: () => {
      queenArcPopup(
        "With a final breath of magic, the Queen severs the thread that bound her beyond time. Her body folds like any mortal's, fading into shadow and silence. \
        She is gone â€” not in battle, not in triumph, but in sorrow.<br><br>\
        The Immortal Queen is no more."
      );
      state.queenArcStep = 999; // lock her arc permanently
      state.lockNormalQueen = false; // free normal cycle after her disappearance
    }
  }
}
]; 


const BIZZARE = [
  { id: 'fund_bizarre', npc: 'The Alchemist', text: "A wild-eyed man bursts into your court clutching a jar of glowing liquid. 'With this, I can turn lead to gold!' he claims, though the air reeks of swamp gas. Genius or madman, he asks for royal funding to finish his work.", effects:[
    {k:'Money', d:-3}, {k:'Culture', d:2}, {k:'Education', d:1}
  ]},
  { id: 'plead_help', npc: 'The Envoy', text: "A rider from Wynthor kneels before you, voice raw with desperation. 'Our fields are barren, our children starving. We beg for grain and mercy.' Aid would save lives, but your own stores are running thin.", effects:[
    {k:'Population', d:-2}, {k:'Money', d:1}, {k:'Control', d:-1}
  ]},
  { id: 'urgent_marriage', npc: 'Lord Atherwyn', text: "A noble lord stands before your throne. 'Your Majesty, marry my daughter and unite our houses. Refusal will not be forgotten.' The court holds its breath as his gaze sharpens.", effects:[
    {k:'Control', d:2}, {k:'Money', d:-2}, {k:'Culture', d:1}
  ]},
  { id: 'royal_masquerade', npc: 'The Queen', text: "The Queen sweeps in, eyes alight. 'Let us host a masquerade for the visiting dignitaries â€” wine flowing, masks glittering, feasts unending.' The steward mutters about the treasuryâ€™s meager purse.", effects:[
    {k:'Culture', d:3}, {k:'Money', d:-3}, {k:'Population', d:1}
  ]},
  { id: 'ban_festival', npc: 'The Minister of Control', text: "Your advisors warn that the spring festival stirs unrest. 'Ban it, and order will hold,' says the minister. Outside, the scent of roasting meat drifts in, and children laugh in the streets.", effects:[
    {k:'Culture', d:-3}, {k:'Control', d:2}, {k:'Population', d:-1}
  ]}
];


  const CRITICAL = [
    {id:'c01', text:'A palace coup threatens the throne. Crush or negotiate?', effect:6},
    {id:'c02', text:'A continent-wide pandemic collapses supply chains. Mobilize now?', effect:6},
    {id:'c03', text:'A massive earthquake levels the capital. Lead rebuilding?', effect:6},
    {id:'c04', text:'A revolution stirs in the industrial centers. Suppress or concede?', effect:6},
    {id:'c05', text:'Foreign powers demand tribute or war looms. Respond?', effect:6}
  ];


    const ONEUP = [
    {id:'u01', text:'A reclusive healer from the border claims to possess a vial that binds you to life; accept the healer\'s costly cure?', revive:true},
    {id:'u02', text:'A hidden reliquary is uncovered beneath the chapel at Kingswell; it contains a blessing that might restore your life at a price; claim it?', revive:true},
    {id:'u03', text:'An oath-bound knight offers to trade his soul-ward for a single boon that preserves your line; demand the knight\'s boon?', revive:true}
  ];


      const MINI_EVENTS = [
  {id:'m01', text:'A market fire destroys goods.', effects:[
    {k:'Money', d:-2}, {k:'Population', d:-1}
  ]},
  {id:'m02', text:'A street performer delights the crowd.', effects:[
    {k:'Culture', d:1}, {k:'Population', d:1}
  ]},
  {id:'m03', text:'A thief is caught stealing from the treasury.', effects:[
    {k:'Money', d:1}, {k:'Control', d:1}
  ]},
  {id:'m04', text:'A visiting healer cures the sick in a village.', effects:[
    {k:'Population', d:2}
  ]},
  {id:'m05', text:'Merchants report higher sales after a feast.', effects:[
    {k:'Money', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m06', text:'A militia patrol catches a group of bandits.', effects:[
    {k:'Strength', d:1}, {k:'Control', d:1}
  ]},
  {id:'m07', text:'A drunk noble causes a scene at the court.', effects:[
    {k:'Culture', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m08', text:'An unexpected tax windfall fills the coffers.', effects:[
    {k:'Money', d:2}
  ]},
  {id:'m09', text:'A sudden downpour ruins the town fair.', effects:[
    {k:'Culture', d:-1}, {k:'Population', d:-1}
  ]},
  {id:'m10', text:'A well-received sermon draws large crowds.', effects:[
    {k:'Religion', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m11', text:'A brawl in the tavern injures several locals.', effects:[
    {k:'Population', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m12', text:'A group of scholars publishes a new map.', effects:[
    {k:'Education', d:1}, {k:'Control', d:1}
  ]},
  {id:'m13', text:'A granary rat infestation spoils the harvest.', effects:[
    {k:'Population', d:-2}
  ]},
  {id:'m14', text:'A new sculpture is unveiled in the plaza.', effects:[
    {k:'Culture', d:1}
  ]},
  {id:'m15', text:'A guard is caught taking bribes.', effects:[
    {k:'Control', d:-1}, {k:'Money', d:-1}
  ]},
  {id:'m16', text:'A bard performs a ballad about the queen.', effects:[
    {k:'Culture', d:1}, {k:'Control', d:1}
  ]},
  {id:'m17', text:'A bridge collapse disrupts trade routes.', effects:[
    {k:'Control', d:-1}, {k:'Money', d:-2}
  ]},
  {id:'m18', text:'A foreign merchant donates to the abbey.', effects:[
    {k:'Religion', d:1}, {k:'Money', d:1}
  ]},
  {id:'m19', text:'A traveling teacher holds free classes.', effects:[
    {k:'Education', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m20', text:'A gang of pickpockets targets the market.', effects:[
    {k:'Money', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m21', text:'A charity bake sale raises funds for the poor.', effects:[
    {k:'Population', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m22', text:'A lightning strike sets a barn on fire.', effects:[
    {k:'Population', d:-1}, {k:'Money', d:-1}
  ]},
  {id:'m23', text:'A scribe discovers an error in the census.', effects:[
    {k:'Control', d:1}
  ]},
  {id:'m24', text:'A popular song spreads across the realm.', effects:[
    {k:'Culture', d:1}
  ]},
  {id:'m25', text:'A shipment of grain arrives ahead of schedule.', effects:[
    {k:'Population', d:1}, {k:'Money', d:1}
  ]}
];

  // Essence configuration
  const ALL_ESSENCES = [
    {k:'Population', icon:'ðŸ‘¥'},
    {k:'Money', icon:'ðŸ’°'},
    {k:'Strength', icon:'ðŸ—¡ï¸'},
    {k:'Religion', icon:'âœï¸'},
    {k:'Culture', icon:'ðŸŽ­'},
    {k:'Education', icon:'ðŸŽ“'},
    {k:'Control', icon:'ðŸ›ï¸'}
  ];
  const GAME_OVER_REASONS = {
  'Population': {
    min: "Your people deserted the kingdom due to neglect and famine, leaving your throne abandoned.",
    max: "Your lands buckled under the strain of overpopulation, sparking famine and unrest that toppled your rule."
  },
  'Money': {
    min: "Your treasury ran dry, and with no gold to pay soldiers or buy loyalty, your crown was seized.",
    max: "Your hoarded wealth fueled envy and rebellion among the nobles, ending in your overthrow."
  },
  'Strength': {
    min: "Your weakened armies crumbled, and invaders stormed your capital, forcing your surrender.",
    max: "Your relentless militarism drove your generals to unite against you in a bloody coup."
  },
  'Religion': {
    min: "Your abandonment of faith alienated the clergy, who led the masses to depose you.",
    max: "Your zealous rule ignited holy uprisings that consumed your reign."
  },
  'Culture': {
    min: "Your neglect of the arts drained your kingdomâ€™s spirit, and the people turned against you.",
    max: "Your extravagant court alienated the masses, who revolted and ended your reign."
  },
  'Education': {
    min: "Ignorance spread unchecked, and unrest among the uneducated masses tore your rule apart.",
    max: "Your intellectual elite grew arrogant, challenging and ultimately dismantling your authority."
  },
  'Control': {
    min: "Your lax governance plunged the realm into chaos, and warlords seized the crown.",
    max: "Your oppressive grip bred rebellion, and the people rose to overthrow you."
  }
};

  // State
let state = {
  year: 1512,
  decCount: 0,
  difficulty: 'easy',
  running: false,
  hideConsequences: false,
  hidePreview: false,
  essences: {},
  scenePool: [],
  log: [],
  traits: [],
  achievements: new Set(),
  miniEventsTriggeredCount: 0,
  currentScene: null,
  persona: 'none',
  playerName: 'The King',
  lastDecadeUsed: new Set(),
  currentDecadeUsed: new Set(),
  usedSpecials: new Set(),
  
  // New tracking for unusual decisions
  unusualDeclines: [],
  unusualAccepts: [], 
  
  // New tracking for streak achievements
  consecutiveAgree: 0,
  consecutiveDecline: 0
};

  // DOM
  const yearEl = document.getElementById('yearDisplay');
  const startBtn = document.getElementById('startBtn');
  const difficultyEl = document.getElementById('difficulty');
  const sceneCard = document.getElementById('sceneCard');
  const choicesBox = document.getElementById('choicesBox');
  const acceptBtn = document.getElementById('acceptBtn');
  const declineBtn = document.getElementById('declineBtn');

// Queen-specific buttons
const queenChoicesBox = document.getElementById('queenChoicesBox');
const queenAgreeBtn = document.getElementById('queenAgreeBtn');
const queenRefuseBtn = document.getElementById('queenRefuseBtn');
  const essList = document.getElementById('essencesList');
  const decCountEl = document.getElementById('decCount');
  const logEl = document.getElementById('log');
  const hideConsEl = document.getElementById('hideConsequences');
  const hidePrevEl = document.getElementById('hidePreview');
  const nameOverlay = document.getElementById('nameOverlay');
  const acceptName = document.getElementById('acceptName');
  const randomize = document.getElementById('randomize');
  const playerNameInput = document.getElementById('playerName');
  const personaEl = document.getElementById('persona');
  const traitsList = document.getElementById('traitsList');
  const achList = document.getElementById('achList');
  const playerPlate = document.getElementById('playerPlate');

  // Utility
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function shuffle(arr){ const c=arr.slice(); for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]]; } return c; }

  // Initialize essences depending on difficulty
  function initEssences(){ state.essences = {}; const mode = state.difficulty; let keys;
    if(mode === 'easy') keys = ALL_ESSENCES.slice(0,5).map(e=>e.k); // first 5
    else keys = ALL_ESSENCES.map(e=>e.k); // all 7
    keys.forEach(k=> state.essences[k] = 10); // start center    
  }

  
  function renderEssences(){ essList.innerHTML = '';
    const max = 20;
    Object.keys(state.essences).forEach(k=>{ const val = state.essences[k]; const pct = Math.round((val/max)*100);
      const meta = ALL_ESSENCES.find(e=>e.k===k) || {icon:'?'};
      const node = document.createElement('div'); node.className='ess';
      if(val <=3 || val >= 17) { node.classList.add('critical-border'); }
      const inner = `
  <div class="label">${meta.icon} ${k}<span class="critical-dot"></span></div>
  <div class="bar essence-bar" data-essence="${k}"><i style="width:${pct}%"></i></div>
  <div class="value">${val}</div>
      `;
      node.innerHTML = inner;
      const bar = node.querySelector('.bar > i');
      if(val <=3) { bar.style.background = 'linear-gradient(90deg,#ff9b9b,#ff6b6b)'; node.classList.add('critical'); }
      else if(val >= 17){ bar.style.background = 'linear-gradient(90deg,#9bf6b6,#64d368)'; }
      else { bar.style.background = 'linear-gradient(90deg,#ffd166,#ff9f1c)'; }
      essList.appendChild(node);
    });
  }

  function writeLog(text){ state.log.unshift((state.year)+' â€” '+text); logEl.innerHTML = state.log.slice(0,200).map(l=>`<div>${l}</div>`).join(''); }

  // Pool preparation with deduplication by type
// Global/session flag (declare once, outside preparePool)
let suppressQueen = false;

function preparePool() {
    const BIZZARE_CHANCE = 0.15;
    let pool = [];

    if (typeof state.queenArcStage === 'undefined') state.queenArcStage = 0;
    if (typeof state.queenArcActive === 'undefined') state.queenArcActive = true;
    if (typeof state.newArcStage === 'undefined') state.newArcStage = 0;
    if (typeof state.queenDeclineCount === 'undefined') state.queenDeclineCount = 0;
    if (typeof state.lockNormalQueen === 'undefined') state.lockNormalQueen = false;

    const queenArcIds = ['q21', 'q22', 'q23', 'q24', 'q25'];
    const newArcIds = ['q26', 'q27', 'q28']; // standard new arc
    const q29Id = 'q29'; // special case

    function getAnyNPCScene(list = NPC_SCENARIOS) {
        if (!list || list.length === 0) {
            if (REPEATING.length > 0) return shuffle(REPEATING)[0];
            if (SPECIAL.length > 0) return shuffle(SPECIAL)[0];
            return { id: 'fallback', text: 'No scenes available', npc: null };
        }
        return shuffle(list)[0];
    }

    const decadeNum = Math.floor(((state.year || 1512) - 1512) / 20) + 1;
    const decadeSpecials = SPECIAL.filter(s => s.decade === decadeNum);
    pool.push(...decadeSpecials);
    pool.push(...REPEATING, ...NPC_SCENARIOS, ...BIZZARE.filter(n => !n.decade || n.decade === decadeNum));

    if (!state.specialsThisDecade) state.specialsThisDecade = 0;

    // === Arc & Queen handling ===
    if (state.decCount === 0 && state.running) {
        let npcScene;

        // 1. Immortality arc
        if (state.queenArcActive) {
            if (state.queenArcStage < queenArcIds.length) {
                npcScene = NPC_SCENARIOS.find(s => s.id === queenArcIds[state.queenArcStage]) || getAnyNPCScene();
                state.queenArcStage++;
            } else {
                state.queenArcActive = false;
                npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc === 'The Queen' && /^q0\d/.test(s.id)));
            }
        }
        // 2. New Arc (q26 â†’ q27 â†’ q28)
        else if (state.newArcStage > 0 && state.newArcStage <= newArcIds.length) {
            npcScene = NPC_SCENARIOS.find(s => s.id === newArcIds[state.newArcStage - 1]) || getAnyNPCScene();
            state.newArcStage++;
            if (state.newArcStage > newArcIds.length) {
                state.lockNormalQueen = false; // Unlock after q28
            }
        }
        // 3. Special q29 path (after decline at q27)
        else if (state.newArcStage === 99) {
            npcScene = NPC_SCENARIOS.find(s => s.id === q29Id) || getAnyNPCScene();
            state.newArcStage = 0;
            state.lockNormalQueen = false; // Unlock again after q29
        }
        // 4. Normal Queen scenarios (if not locked)
        else if (!state.lockNormalQueen) {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc === 'The Queen' && /^q0\d/.test(s.id)));
        }
        // 5. If locked, no Queen scenario
        else {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc !== 'The Queen'));
        }

        // ðŸš« Suppress queen scenario if suppression is active
        if (suppressQueen && npcScene && /^q\d+/i.test(npcScene.id)) {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc !== 'The Queen'));
        }

        // Fill rest of pool
        pool = [npcScene];
        const availableSpecials = SPECIAL.filter(s => s.decade === decadeNum && !state.usedSpecials.has(s.id));
        let specials = availableSpecials.length >= 2 ? shuffle(availableSpecials).slice(0, 2) : shuffle(SPECIAL).slice(0, 2);
        specials.forEach(s => state.usedSpecials.add(s.id));
        pool.push(...specials);

        let repsCandidates = shuffle(REPEATING.filter(r => !state.lastDecadeUsed.has(r.id)));
        while (pool.length < 6 && repsCandidates.length) pool.push(repsCandidates.shift());

        if (Math.random() < BIZZARE_CHANCE) {
            let slot = Math.floor(Math.random() * pool.length);
            if (slot === 0) slot = 1 + Math.floor(Math.random() * (pool.length - 1));
            pool[slot] = shuffle(BIZZARE)[0];
        }

        state.scenePool = [pool[0], ...shuffle(pool.slice(1))];
        return;
    }

    // Normal decade pool
    const availableSpecials = SPECIAL.filter(s => s.decade === decadeNum && !state.usedSpecials.has(s.id));
    let specials = availableSpecials.length >= 2 ? shuffle(availableSpecials).slice(0, 2) : shuffle(SPECIAL).slice(0, 2);
    pool.push(...specials);
    specials.forEach(s => state.usedSpecials.add(s.id));

    let repsCandidates = shuffle(REPEATING.filter(r => !state.lastDecadeUsed.has(r.id)));
    while (pool.length < 6 && repsCandidates.length) pool.push(repsCandidates.shift());

    if (pool.length < 6) pool.push(...shuffle(REPEATING).slice(0, 6 - pool.length));

    if (Math.random() < BIZZARE_CHANCE) {
        let slot = Math.floor(Math.random() * pool.length);
        if (slot === 0) slot = 1 + Math.floor(Math.random() * (pool.length - 1));
        pool[slot] = shuffle(BIZZARE)[0];
    }

    const critChance = state.difficulty === 'hard' ? 0.45 : 0.12;
    if (Math.random() < critChance) {
        const slot = Math.floor(Math.random() * pool.length);
        pool[slot] = shuffle(CRITICAL)[0];
    }

    // ðŸš« Suppress queen scenarios if suppression is active
    if (suppressQueen) {
        pool = pool.filter(scene => !/^q\d+/i.test(scene.id));
    }

    state.scenePool = shuffle(pool);
}
  
  // Apply scene effects
  function applyEffects(scene, accepted) {
  const consequences = [];
  if (!scene) return consequences;

  if (scene.id && scene.id.startsWith('c')) {
    // Critical â€” distribute effect among all essences
    const total = scene.effect || 5;
    const keys = Object.keys(state.essences);
    const base = Math.floor(total / keys.length);
    let rem = total - base * keys.length;
    for (let i = 0; i < keys.length; i++) {
      const amt = base + (rem > 0 ? 1 : 0);
      if (rem > 0) rem--;
      const delta = accepted ? -amt : amt;
      const before = state.essences[keys[i]];
      state.essences[keys[i]] = clamp(before + delta, 0, 20);
      consequences.push({ k: keys[i], from: before, to: state.essences[keys[i]] });
    }
  } 
  else if (scene.effects) {
    // All scenarios now use fixed effects
    for (let i = 0; i < scene.effects.length; i++) {
      const { k, d } = scene.effects[i];
      if (!(k in state.essences)) continue;
      const delta = accepted ? d : -d;
      const before = state.essences[k];
      state.essences[k] = clamp(before + delta, 0, 20);
      consequences.push({ k, from: before, to: state.essences[k] });
    }
  }

  return consequences;
} 

  function adjustScenarioText(scene) {
  return scene; // No captions or icons added
}

  function mapTarget(name){ // map older shorthand to full keys
    if(name==='People') return 'Population'; return name;
  }

  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  // Decision handling
function makeDecision(accepted) {
    if (!state.running) return;
    const scene = state.currentScene;
    if (!scene) return;

    acceptBtn.disabled = true;
    declineBtn.disabled = true;

    const queenFailureMessages = {
        q21: "The Queen's eyes dim. Without your support from the very start, her dream never leaves the palace walls. She ages in quiet sorrow.",
        q22: "Years of searching end in despair. The Queen collapses in the great hall as news of your refusal reaches her.",
        q23: "The ritual is abandoned midway. Decades of preparation dissolve into rumor, and the Queen retreats from public life, never to be seen again.",
        q24: "So close to the end, the Queen watches the circle break. Tears carve deep lines on her face as time claims her swiftly.",
        q25: "With the final step denied, the Queen accepts her fate. She smiles faintly â€” perhaps in relief, perhaps in resignation â€” before vanishing from the realm's story."
    };

    const consequences = applyEffects(scene, accepted);

    // === Special popup for q26/q27 ===
    if ((scene.id === 'q26' || scene.id === 'q27') && scene.resultText) {
        const popupMsg = accepted ? scene.resultText.accept : scene.resultText.decline;
        queenArcPopup(popupMsg);
    }

    // === q28 Finale Popup ===
if (scene.id === 'q28') {
  let finalMessage;
  if (accepted) {
    finalMessage = "With your blessing, the Queen bears your child â€” the realm rejoices, and a new dynasty begins.";
    state.achievements.add("Heir to the Throne");

    // Start child mini-game *after* the popup is dismissed
    queenArcPopup(finalMessage, {
      cssClass: 'queen-finale-popup',
      callback: () => { if (typeof window.startChildMiniGame === 'function') window.startChildMiniGame(); }
    });
  } else {
    finalMessage = "The Queen departs in silence. Without an heir, the realmâ€™s future remains uncertain.";
    queenArcPopup(finalMessage, { cssClass: 'queen-finale-popup' });
  }
  state.newArcStage = 0;
  state.lockNormalQueen = false;
}




    // === New Arc Trigger (declines unlock q26) ===
    if (scene.npc === 'The Queen') {
        const sceneNum = parseInt(scene.id.replace('q', ''), 10);

        if (sceneNum >= 1 && sceneNum <= 20 && !state.lockNormalQueen) {
            if (!accepted) {
                state.queenDeclineCount++;
            } else {
                state.queenDeclineCount = 0;
            }

            if (state.queenDeclineCount === 3) {
                state.queenDeclineCount = 0;
                state.lockNormalQueen = true;
                state.newArcStage = 1; // Will start at q26 next decade
            }
        }
    }

    // === Arc Progress ===
    if (scene.id === 'q26') {
        state.newArcStage = 2; // q27 next decade
    }
    if (scene.id === 'q27') {
        // if declined, force q29 instead of q28
        if (!accepted) {
            state.newArcStage = 99; // special marker for q29
        } else {
            state.newArcStage = 3;  // go to q28
        }
    }
    if (scene.id === 'q29') {
        state.newArcStage = 0;
        state.lockNormalQueen = false;
    }

    // === Immortality Arc === (unchanged)
    const immortalityIds = ['q21', 'q22', 'q23', 'q24', 'q25'];
    if (state.queenArcActive && immortalityIds.includes(scene.id)) {
    if (!state.queenArcHistory) state.queenArcHistory = [];
    const wasRight = accepted;
    state.queenArcHistory.push(wasRight);

    if (!wasRight) {
        state.queenArcActive = false;
        let colorClass = '';
        switch (scene.id) {
            case 'q21': colorClass = 'queen-fail-early'; break;
            case 'q22':
            case 'q23': colorClass = 'queen-fail-mid'; break;
            case 'q24':
            case 'q25': colorClass = 'queen-fail-late'; break;
        }
        const failMsg = queenFailureMessages[scene.id] || "The Queen's fate is sealed.";
        queenArcPopup(failMsg);

        // âœ… Ban Queen for the rest of the game
        suppressQueen = true;
        state.lockNormalQueen = true;
    } else {
        const currentIndex = immortalityIds.indexOf(scene.id);
        if (currentIndex === immortalityIds.length - 1) {
            state.achievements.add("Eternal Love");
            queenArcPopup("Achievement unlocked: Eternal Love â€” The Queen now reigns beside you, forever.");
        }
    }
}



    // === Remove qXX for rest of decade ===
const decadeStart = state.year - 9;
const hasRecentQueenScenario = state.log.find(l =>
  l && typeof l.id === 'string' &&
  l.id.startsWith('q') &&
  l.year >= decadeStart
);
// After showing any Queen scene, strip remaining Queen scenes from the current pool
if (scene.id && /^q\d+$/i.test(scene.id) && Array.isArray(state.scenePool)) {
  state.scenePool = state.scenePool.filter((s, index) =>
    index === 0 || !(s && typeof s.id === 'string' && /^q\d+$/i.test(s.id))
  );
}

    // === Decade Progress ===
    state.decCount++;
    decCountEl.textContent = state.decCount;
    state.decisionsThisDecade = (state.decisionsThisDecade || 0) + 1;
    document.getElementById('decCount').textContent = state.decisionsThisDecade;

    if (state.decisionsThisDecade >= 6) {
        state.decisionsThisDecade = 0;
        state.decadeNumber = (state.decadeNumber || 1) + 1;
        state.year = (state.year || 1512) + 10;
        document.getElementById('yearDisplay').textContent = state.year;
    }

    // === Logging & Updates ===
    let logText = (accepted ? 'Accepted: ' : 'Declined: ') + scene.text;
    if (!state.hideConsequences) {
        const parts = consequences.map(c => `${iconFor(c.k)} ${c.k} ${c.to - c.from >= 0 ? '+' : ''}${c.to - c.from}`);
        if (parts.length) logText += ' â€” Effects: ' + parts.join(', ');
    }
    writeLog(logText);
    renderEssences();
    consequences.forEach(({ k, from, to }) => {
        const delta = to - from;
        if (delta !== 0) highlightEssenceChange(k, delta);
    });
    flash(accepted);

    // === Unlimited Life ===
    const unlimitedLife = true;
    if (!unlimitedLife && checkGameOver()) {
        checkAchievements();
        return;
    }

    // === Next Scene ===
    setTimeout(() => {
        if (state.decCount >= 6) {
            state.year += 10;
            state.decCount = 0;
            writeLog('A decade passes â€” Year ' + state.year);
            yearEl.textContent = state.year;
            state.lastDecadeUsed = new Set(state.currentDecadeUsed);
            state.currentDecadeUsed = new Set();
            if (Math.random() < 0.5) triggerMiniEvent();
            checkAchievements();
            if (state.year >= 2012) { 
                winGame();
                return;
            }
            preparePool();
        }
        presentScene(nextScene());
    }, 480);
} 

  function presentScene(s) {
    if (!s) return;
    
    // Remove old fade classes so animation can retrigger
    sceneCard.classList.remove('fade-in', 'fade-out');
    void sceneCard.offsetWidth; // Force reflow

    // Fade out current card
    sceneCard.classList.add('fade-out');

    // Wait for fade-out to complete
    setTimeout(() => {
        state.currentScene = adjustScenarioText(s);
        if (s.id) state.currentDecadeUsed.add(s.id);

        // Reset base class
        sceneCard.className = 'scene-card';

        // Assign type-specific class
        if (s.id && s.id.startsWith('r')) sceneCard.classList.add('repeating');
        else if (s.id && s.id.startsWith('s')) sceneCard.classList.add('special-scenario');
        else if (s.id && s.id.startsWith('c')) sceneCard.classList.add('critical');
        else if (s.id && s.id.startsWith('q')) sceneCard.classList.add('npc-scenario');
        else if (s.id && s.id.startsWith('u')) sceneCard.classList.add('oneup');

        // Bizarre scenario check
        if (BIZZARE.some(item => item.id === s.id)) {
            sceneCard.classList.add('bizarre-scenario');
        }

        // Update content
        sceneCard.innerHTML = `<div class="scene-card-content">${s.text}</div>`;

        // Default: hide/show correct decision boxes
        if (s.id && s.id.startsWith('q')) {
            choicesBox.style.display = 'none';
            queenChoicesBox.style.display = 'flex';
            queenAgreeBtn.disabled = false;
            queenRefuseBtn.disabled = false;
        } else {
            choicesBox.style.display = 'flex';
            queenChoicesBox.style.display = 'none';
            acceptBtn.disabled = false;
            declineBtn.disabled = false;
        }

        // === Special case: q29 ===
        if (s.id === 'q29') {
            // Hide both normal and Queen decision boxes
            choicesBox.style.display = 'none';
            queenChoicesBox.style.display = 'none';

            // Create ellipsis button inside same parent container
            let ellipsisBtn = document.getElementById("ellipsisBtn");
            if (!ellipsisBtn) {
                ellipsisBtn = document.createElement("button");
                ellipsisBtn.id = "ellipsisBtn";
                ellipsisBtn.className = "choice fullwidth"; // styled like choices, but full width
                ellipsisBtn.textContent = "...";
                choicesBox.parentNode.appendChild(ellipsisBtn);
            }

            ellipsisBtn.style.display = "block";
            ellipsisBtn.disabled = false;

            ellipsisBtn.onclick = () => {
                ellipsisBtn.disabled = true;
                queenArcPopup(
                    "The Queen withdraws from the kingdom, shrouded in grief. She reverses the 'blessing' of immortality and fades from history. She will never be seen again.",
                    { cssClass: 'queen-finale-popup' }
                );

                // Suppress Queen scenarios permanently
                state.newArcStage = 0;
                state.lockNormalQueen = true;
                suppressQueen = true;

                ellipsisBtn.style.display = "none";
                setTimeout(() => { presentScene(nextScene()); }, 800);
            };
        } else {
            const ellipsisBtn = document.getElementById("ellipsisBtn");
            if (ellipsisBtn) ellipsisBtn.style.display = "none";
        }

        // Fade in
        sceneCard.classList.remove('fade-out');
        sceneCard.classList.add('fade-in');

        // Preview handlers for vertical alignment
        requestAnimationFrame(() => {
            sceneCard.classList.remove('centered', 'topAligned');
            if (sceneCard.scrollHeight > sceneCard.clientHeight) {
                sceneCard.classList.add('topAligned');
            } else {
                sceneCard.classList.add('centered');
            }
        });

        // Render choice preview
        renderChoicePreview(s);

    }, 400); // match CSS transition duration
}

function nextScene() {
  // Ensure there is a pool
  if (!state.scenePool || state.scenePool.length === 0) {
    if (typeof preparePool === 'function') {
      preparePool();
    } else {
      console.warn('preparePool() is not defined; nextScene() returning null.');
      state.currentScene = null;
      return null;
    }
  }

  // After one Queen (qXX) appears in a decade, strip additional qXX from the remainder
try {
  const hadQueenThisDecade =
    state.currentDecadeUsed &&
    [...state.currentDecadeUsed].some(id => /^q\d+$/i.test(id));

  if (hadQueenThisDecade && Array.isArray(state.scenePool)) {
    state.scenePool = state.scenePool.filter((scene, index) =>
      index === 0 || !(scene && typeof scene.id === 'string' && /^q\d+$/i.test(scene.id))
    );
  }
} catch (err) {
  console.warn('nextScene: purge step skipped:', err);
}

  // Pop and set current scene
  const scene = (state.scenePool && state.scenePool.shift()) || null;
  state.currentScene = scene;
  return scene;
}

  function renderChoicePreview(scene){ // show subtle highlight on essences for hover
    // remove previews
    const bars = document.querySelectorAll('.ess .bar > i'); bars.forEach(b=>b.style.opacity='1');
    // compute hypothetical impact (no exact numbers, just which essences affected)
    const affected = new Set();
if (scene.id && scene.id.startsWith('c')) {
  Object.keys(state.essences).forEach(k => affected.add(k));
}
if (scene.targets && scene.targets.length) {
  scene.targets.forEach(t => {
    const k = mapTarget(t);
    if (k in state.essences) affected.add(k);
  });
}
if (scene.effects && scene.effects.length) {
  scene.effects.forEach(e => {
    if (e.k in state.essences) affected.add(e.k);
  });
}
    acceptBtn.onmouseenter = () => {
  if (!hidePreviewCheckbox.checked) highlightAffected(affected, true);
};
acceptBtn.onmouseleave = () => renderEssences();

declineBtn.onmouseenter = () => {
  if (!hidePreviewCheckbox.checked) highlightAffected(affected, false);
};
declineBtn.onmouseleave = () => renderEssences();

queenAgreeBtn.onmouseenter = () => {
  if (!hidePreviewCheckbox.checked) highlightAffected(affected, true);
};
queenAgreeBtn.onmouseleave = () => renderEssences();

queenRefuseBtn.onmouseenter = () => {
  if (!hidePreviewCheckbox.checked) highlightAffected(affected, false);
};
queenRefuseBtn.onmouseleave = () => renderEssences();
  }

  function highlightAffected(setAff, isAccept){ // gently tint bars
    const nodes = Array.from(essList.children);
    nodes.forEach(n=>{ const label = n.querySelector('.label').textContent.trim(); const key = label.replace(/^\S+\s/,''); const bar = n.querySelector('.bar > i'); if(setAff.has(key)){
        bar.style.boxShadow = '0 6px 18px rgba(255,255,255,0.03)'; bar.style.opacity='1'; bar.style.transform='scaleY(1.04)';
      } else { bar.style.opacity='0.35'; }
    });
  }

  // =====================
// UI Helpers
// =====================

// Essence icon lookup
function iconFor(k) {
  const e = ALL_ESSENCES.find(x => x.k === k);
  return e ? e.icon : 'â—¼ï¸';
}

// Popup system for Queen & special arcs
function queenArcPopup(message, options = {}) {
  const { cssClass = '', callback = null } = options;

  // Create overlay
  const overlay = document.createElement('div');
  overlay.className = 'queen-popup-overlay';

  // Create popup
  const popup = document.createElement('div');
  popup.className = `queen-popup ${cssClass}`;
  popup.innerHTML = `
    <div class="queen-popup-text">${message}</div>
    <button class="queen-popup-close">Continue</button>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  // Animate in
  setTimeout(() => {
    overlay.classList.add('show');
    popup.classList.add('show');
  }, 50);

  // Close on button click
  popup.querySelector('.queen-popup-close').addEventListener('click', () => {
    overlay.classList.remove('show');
    popup.classList.remove('show');
    setTimeout(() => {
      overlay.remove();
      if (typeof callback === "function") {
        callback(); // âœ… Run callback after popup is fully dismissed
      }
    }, 500);
  });
}

// Button click animation feedback
function flash(accepted) {
  const btn = accepted ? acceptBtn : declineBtn;
  try {
    btn.animate(
      [
        { transform: 'scale(1)' },
        { transform: 'scale(0.98)' },
        { transform: 'scale(1)' }
      ],
      { duration: 240 }
    );
  } catch (e) {}
}

  // Game over & win
function checkGameOver() {
    const entries = Object.entries(state.essences);
    for (const [k, v] of entries) {
        if (v <= 0 || v >= 20) {
            state.running = false;
            choicesBox.style.display = 'none';
            acceptBtn.disabled = true;
            declineBtn.disabled = true;

            // Match the key to the GAME_OVER_REASONS format
            const properName = k.charAt(0).toUpperCase() + k.slice(1);
            const reasonData = GAME_OVER_REASONS[properName];

            // Fallback if no matching reason found
            let reason;
            if (reasonData) {
                reason = v <= 0 ? reasonData.min : reasonData.max;
            } else {
                reason = v <= 0 
                    ? `${properName} has completely collapsed.` 
                    : `${properName} has spiraled out of control.`;
            }

            showGameOverOverlay(reason);                         
            writeLog(`Game Over â€” ${properName} reached ${v}. ${reason}`);

            // âœ… Reset queen suppression on game over
            suppressQueen = false;
            console.log("Queen suppression reset at game over");

            return true; // stop further actions
        }
    }
    return false;
}

  function winGame(){ state.running=false; choicesBox.style.display='none'; acceptBtn.disabled=true; declineBtn.disabled=true; const msg = `Victory â€” ${state.playerName} reigned to ${state.year}.`; sceneCard.textContent = msg; const btn = document.createElement('button'); btn.textContent='Play again'; btn.className='choice'; btn.style.marginTop='12px'; btn.onclick = ()=> showNameOverlay(); sceneCard.appendChild(btn); writeLog('Victory â€” reached '+state.year); computeEnding(); }

  function computeEnding(){ // simple ending descriptions based on top essences
    const sorted = Object.entries(state.essences).sort((a,b)=>b[1]-a[1]); const top = sorted.slice(0,2).map(s=>s[0]); let title='A Long Reign';
    if(top.includes('Population') && top.includes('Culture')) title='The Golden Age';
    else if(top.includes('Strength') && !top.includes('Culture')) title='The Iron Throne';
    else if(top.includes('Money') && top.includes('Control')) title='The Merchant Commonwealth';
    else if(top.includes('Religion') && top.includes('Population')) title='The Pious Kingdom';
    writeLog(`Ending: ${title}`);
  }

  // Mini events between decades
    function triggerMiniEvent() {
    state.miniEventsTriggeredCount++; checkAchievements(); // count this mini-event

    const ev = shuffle(MINI_EVENTS)[0];

    // Prepare overlay elements
    const overlay = document.getElementById('miniEventOverlay');
    const textEl = document.getElementById('miniEventText');
    const effectsEl = document.getElementById('miniEventEffects');

    // Set main text
    textEl.textContent = ev.text;

    // Apply effects and build effect display
    const effectsHtml = [];
    ev.effects.forEach(e => {
        if (e.k in state.essences) {
            const before = state.essences[e.k];
            state.essences[e.k] = clamp(before + e.d, 0, 20);
            const delta = e.d >= 0 ? `+${e.d}` : `${e.d}`;
            effectsHtml.push(`${iconFor(e.k)} ${e.k} ${delta}`);
        }
    });
    effectsEl.innerHTML = `<div style="font-weight:700;">Effects: ${effectsHtml.join(', ')}</div>`;

    // === Fade In ===
    overlay.classList.remove('fade-in', 'fade-out');
    overlay.style.display = 'flex'; // show it immediately
    overlay.setAttribute('aria-hidden', 'false');
    requestAnimationFrame(() => { // wait until next frame
    overlay.classList.add('fade-in'); // then start fade
});

    // Update essences in sidebar
    renderEssences();

    // Log with highlight
    writeLog(`<span class="mini-event-log">Mini-event: ${ev.text}</span>`);
}

function handleDecision(isAgree) {
  if (isAgree) {
    state.consecutiveAgree++;
    state.consecutiveDecline = 0;
    if (state.consecutiveAgree >= 5) {
      unlock('Steadfast Supporter'); // Agreed 5 times in a row
    }
  } else {
    state.consecutiveDecline++;
    state.consecutiveAgree = 0;
    if (state.consecutiveDecline >= 5) {
      unlock('Resolute Dissenter'); // Declined 5 times in a row
    }
  }
  checkAchievements(); // Immediately update achievements UI
}

  // Achievements
  function checkAchievements() {
  // Longevity
  if (state.year >= 1600) unlock('Survived the 16th Century');
  if (state.year >= 1800) unlock('Centuries of Rule');
  if (state.year >= 2000) unlock('Long Reign');

  // Balanced
  if (Object.values(state.essences).every(v => v >= 8 && v <= 12)) {
    unlock('Godspeed, King');
  }

  // First Decade
  if (state.decCount >= 1) unlock('Decisive');

  // Three mini-events
  if (state.miniEventsTriggeredCount >= 3) unlock('Variety is the Spice of Life');

  // Heavy mini-event lover
  if (state.miniEventsTriggeredCount >= 10) unlock('Mini-eventer');

  // Stat-specific highs
  if (state.essences.Religion >= 19) unlock('Pious Ruler');
  if (state.essences.Money >= 19) unlock('Treasure Hoard');
  if (state.essences.Culture >= 19) unlock('Cultural Icon');
  if (state.essences.Population >= 19) unlock('Beloved Leader');
  if (state.essences.Strength >= 19) unlock('Warlord Supreme');
  if (state.essences.Control >= 19) unlock('Iron Grip');
  if (state.essences.Education >= 19) unlock('Enlightened Mind');

  // ===============================
  // NEW ACHIEVEMENTS
  // ===============================

  // Failures in specific decades
  if (state.year >= 1500 && state.year < 1520 && state.gameOver) unlock('Gone Too Soon');
  if (state.year >= 1600 && state.year < 1610 && state.gameOver) unlock('Short 17th Century');
  if (state.year >= 1700 && state.year < 1710 && state.gameOver) unlock('Early 18th Century Collapse');
  if (state.year >= 1800 && state.year < 1810 && state.gameOver) unlock('Failed at the Turn of the Century');
  if (state.year >= 1900 && state.year < 1910 && state.gameOver) unlock('Lost in the New Age');

  // Extreme highs & lows
  if (Object.values(state.essences).some(v => v <= 0)) unlock('On the Brink'); // any stat hits zero
  if (Object.values(state.essences).some(v => v >= 20)) unlock('Overflowing Power'); // max out any stat
  if (state.essences.Population <= 2) unlock('Empty Kingdom');
  if (state.essences.Money <= 2) unlock('Penniless Monarch');
  if (state.essences.Strength <= 2) unlock('Defenseless Ruler');
  if (state.essences.Religion <= 2) unlock('Faithless Crown');
  if (state.essences.Culture <= 2) unlock('Cultural Collapse');
  if (state.essences.Control <= 2) unlock('Chaos Reigns');
  if (state.essences.Education <= 2) unlock('Age of Ignorance');

  // Rare unusual decisions Bizzare Scenarios
  if (state.unusualDeclines && state.unusualDeclines.includes('plead_help')) unlock('Cold-Hearted');
  if (state.unusualAccepts && state.unusualAccepts.includes('fund_bizarre')) unlock('Patron of the Absurd');
  if (state.unusualDeclines && state.unusualDeclines.includes('urgent_marriage')) unlock('Freedom First');
  if (state.unusualAccepts && state.unusualAccepts.includes('royal_masquerade')) unlock('Masked Benefactor');
  if (state.unusualDeclines && state.unusualDeclines.includes('ban_festival')) unlock('Killjoy Monarch');
  
  // Button Presser
  if (state.Declines && state.unusualDeclines.length >= 5) unlock('Chronic Naysayer');
  if (state.Accepts && state.unusualAccepts.length >= 5) unlock('Yes to Everything');

  // Mini-event extremes
  if (state.miniEventsTriggeredCount >= 20) unlock('Mini-event Legend');
  if (state.miniEventsTriggeredCount === 0 && state.year >= 1600) unlock('A Life Without Distraction');

  // Combo conditions
  if (state.essences.Money >= 19 && state.essences.Culture >= 19) unlock('Wealth & Refinement');
  if (state.essences.Strength >= 19 && state.essences.Population >= 19) unlock('Might of the Masses');

  renderAchievements();
}

function unlock(n) {
  if (!state.achievements.has(n)) {
    state.achievements.add(n);
    writeLog('Achievement unlocked: ' + n);
    renderAchievements(); // Immediately render achievements
  }
}

function renderAchievements() {
  const achList = document.getElementById('achList'); // Ensure achList is correct
  achList.innerHTML = Array.from(state.achievements)
    .map(a => `<div class="ach">â€¢ ${a}</div>`).join('');
}
  
// Hook up Mini Event popup dismiss
document.getElementById('dismissMiniEvent')?.addEventListener('click', () => {
    const overlay = document.getElementById('miniEventOverlay');

    // Reset classes and force reflow so animation retriggers
    overlay.classList.remove('fade-in', 'fade-out');
    void overlay.offsetWidth;

    // Start fade-out
    overlay.classList.add('fade-out');

    // After fade completes, hide and mark as hidden
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
    }, 400); // match CSS transition duration
});

   // Persona definitions
  const PERSONAS = {
  beloved: {
    name: 'Beloved Ruler',
    bonus: { Population: 2 }
  },
  iron: {
    name: 'Iron Fist',
    bonus: { Strength: 2 }
  },
  shrewd: {
    name: 'Shrewd Economist',
    bonus: { Money: 2 }
  },
  patron: {
    name: 'Patron of Arts',
    bonus: { Culture: 2 }
  }
};

// Accept name and start the game
acceptName.addEventListener('click', () => {
  const enteredName = playerNameInput.value.trim();

  state.playerName = enteredName || 'The King';
  state.persona = personaEl.value;

  applyPersona(); checkAchievements();
  hideNameOverlay();
  startGame();
});

// Randomize name and persona
randomize.addEventListener('click', () => {
  const personaKeys = Object.keys(PERSONAS);
  const names = ['Polo', 'Eliceo', 'Makol II', 'Somarr'];

  const pickedPersona = personaKeys[Math.floor(Math.random() * personaKeys.length)];
  const pickedName = names[Math.floor(Math.random() * names.length)];

  personaEl.value = pickedPersona;
  playerNameInput.value = pickedName;
});

// Apply persona bonuses & traits
function applyPersona() {
  state.traits = [];

  const persona = PERSONAS[state.persona];
  if (!persona) return;

  // Add trait name
  state.traits.push(persona.name);

  // Apply each essence bonus
  for (const [essence, amount] of Object.entries(persona.bonus)) {
    state.essences[essence] += amount;
  }

  renderTraits();
}

  function renderTraits(){ traitsList.innerHTML = state.traits.map(t=>`<div class="trait">${t}</div>`).join(''); playerPlate.textContent = state.playerName; }

  // Choice listeners Button Handle

acceptBtn.addEventListener('click', () => {
    trackAnyDecision('accept'); // count every accept
    handleDecision(true); // âœ… Track streaks
    makeDecision(true);
});

declineBtn.addEventListener('click', () => {
    trackAnyDecision('decline'); // count every decline
    handleDecision(false); // âœ… Track streaks
    makeDecision(false);
});

queenAgreeBtn.addEventListener('click', () => {
    trackAnyDecision('accept'); // count queen accepts too
    handleDecision(true); // âœ… Track streaks
    makeDecision(true);
});

queenRefuseBtn.addEventListener('click', () => {
    trackAnyDecision('decline'); // count queen declines too
    handleDecision(false); // âœ… Track streaks
    makeDecision(false);
});

hideConsEl.addEventListener('change', () => state.hideConsequences = hideConsEl.checked);
hidePrevEl.addEventListener('change', () => state.hidePreview = hidePrevEl.checked);

    function trackAnyDecision(type) {
    if (!state) state = {}; // ensure state exists

    if (type === 'accept') {
        if (!Array.isArray(state.allAccepts)) state.allAccepts = [];
        state.allAccepts.push(Date.now()); // push dummy value
    } else if (type === 'decline') {
        if (!Array.isArray(state.allDeclines)) state.allDeclines = [];
        state.allDeclines.push(Date.now());
    }

    // Safely check achievements
    if (Array.isArray(state.allDeclines) && state.allDeclines.length >= 5) {
        unlock('Chronic Naysayer');
    }
    if (Array.isArray(state.allAccepts) && state.allAccepts.length >= 5) {
        unlock('Yes to Everything');
    }
}


startBtn.addEventListener('click', () => { showNameOverlay(); });

  // Start game flow
function startGame() {
  // Basic state reset
  state.running = true;
  state.queenIntroIndex = 0; // reset Queen story arc
  state.queenArcActive = true;    // still eligible for Queen scenarios
  state.queenArcStage = 0;        // how far youâ€™ve progressed (0â€“5)
  state.difficulty = difficultyEl.value;
  state.year = 1512;
  state.decCount = 0;
  state.log = [];
  state.currentScene = null;
  state.achievements = new Set();
  state.traits = [];

  // Setup starting state
  initEssences();
  applyStartingPersona();
  renderEssences();
  renderTraits();

  // Prepare first pool â€” will inject q21 if decade start
  preparePool();

  // UI updates
  yearEl.textContent = state.year;
  decCountEl.textContent = state.decCount;
  writeLog(`${state.playerName} begins their reign.`);
  presentScene(nextScene()); // âœ… fixed: removed space between next and Scene
  applyTheme();
}

  function applyStartingPersona(){ // persona might have been set earlier in overlay; apply small buffs
    if(state.persona==='beloved'){ state.traits.push('Beloved Ruler'); state.essences['Population'] = clamp(state.essences['Population']+2,0,20); }
    else if(state.persona==='iron'){ state.traits.push('Iron Fist'); state.essences['Strength'] = clamp(state.essences['Strength']+2,0,20); }
    else if(state.persona==='shrewd'){ state.traits.push('Shrewd Economist'); state.essences['Money'] = clamp(state.essences['Money']+2,0,20); }
    else if(state.persona==='patron'){ state.traits.push('Patron of Arts'); state.essences['Culture'] = clamp(state.essences['Culture']+2,0,20); }
  }

  function applyTheme(){ const root = document.getElementById('mainContainer'); root.classList.remove('difficulty-easy','difficulty-medium','difficulty-hard'); if(state.difficulty==='easy') root.classList.add('difficulty-easy'); else if(state.difficulty==='medium') root.classList.add('difficulty-medium'); else root.classList.add('difficulty-hard'); }

  // Utility to render and initial
  function renderInitialUI(){ renderEssences(); renderAchievements(); renderTraits(); }

  // populate initial essences for UI preview before start
  state.difficulty = difficultyEl.value; initEssences(); renderInitialUI();

  // small helper to compute icon by key used in logs
  function iconFor(k){ const e = ALL_ESSENCES.find(x=>x.k===k); return e? e.icon : '' }

  // load event pool once to expand variety (we dedup similar repeating scenes)
  


// --- Enhanced modal accessibility & floating window ---
// Ensure overlay is a proper floating dialog with focus trap, ESC to close, and draggable header.
(function(){
  const overlay = document.getElementById('nameOverlay');
  if(!overlay) return;
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');
  overlay.setAttribute('aria-hidden','true');
  // create a visually clear modal container if not already
  const card = overlay.querySelector('.card');
  card.setAttribute('tabindex','-1');
  card.style.maxWidth = '520px';
  card.style.width = 'min(92%,540px)';
  card.style.margin = '0';
  card.style.cursor = 'grab';
  card.style.position = 'relative';
  card.style.zIndex = 60;
  card.style.boxShadow = '0 30px 80px rgba(2,6,23,0.8)';
  card.style.border = '1px solid rgba(255,255,255,0.06)';
  // center overlay style
  overlay.style.display = 'none';
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.background = 'linear-gradient(180deg, rgba(2,6,12,0.45), rgba(2,6,12,0.6))';
  overlay.style.backdropFilter = 'blur(4px)';
  overlay.style.zIndex = 50;
  // Add aria labels if missing
  const title = card.querySelector('div') && card.querySelector('div').textContent || 'Persona selection';
  card.setAttribute('aria-label', title);
  // Focus trap variables
  let previouslyFocused = null;
  function trapFocus(e){
    const focusable = card.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(focusable.length === 0) return;
    const first = focusable[0], last = focusable[focusable.length-1];
    if(e.key === 'Tab'){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    } else if(e.key === 'Escape'){
      hideNameOverlay();
    }
  }
  // Redefine show/hide functions to manage focus and background inertness
  const existingShow = window.showNameOverlay || function(){ overlay.style.display='flex'; };
  const existingHide = window.hideNameOverlay || function(){ overlay.style.display='none'; };
  window.showNameOverlay = function(){
    previouslyFocused = document.activeElement;
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    setTimeout(()=>{ const focusable = card.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'); if(focusable.length) focusable[0].focus(); else card.focus(); }, 40);
    document.addEventListener('keydown', trapFocus);
  };
  window.hideNameOverlay = function(){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', trapFocus);
    if(previouslyFocused && previouslyFocused.focus) previouslyFocused.focus();
  };
  // Make modal draggable by pointer on the card
  (function makeDraggable(){
    let isDown=false, startX=0, startY=0, origLeft=0, origTop=0;
    card.style.touchAction = 'none';
    card.addEventListener('pointerdown', (ev)=>{
      isDown=true; card.setPointerCapture(ev.pointerId);
      startX = ev.clientX; startY = ev.clientY;
      const rect = card.getBoundingClientRect();
      origLeft = rect.left; origTop = rect.top;
      card.style.transition = 'none';
      card.style.cursor = 'grabbing';
    });
    window.addEventListener('pointermove', (ev)=>{
      if(!isDown) return;
      let dx = ev.clientX - startX;
      let dy = ev.clientY - startY;
      card.style.transform = `translate(${dx}px, ${dy}px)`;
    });
    window.addEventListener('pointerup', (ev)=>{
      if(!isDown) return;
      isDown=false; card.style.cursor='grab';
      // animate back to center
      card.style.transition = 'transform .42s cubic-bezier(.2,.9,.3,1)';
      card.style.transform = '';
    });
  })();
})();



// --- Naturalized blob motion using Web Animations API ---
(function(){
  const container = document.querySelector('.bg-blobs');
  if(!container) return;
  const blobs = Array.from(container.querySelectorAll('.blob'));
  blobs.forEach((el, idx) => {
    // randomize parameters
    const baseDuration = 25000 + Math.random()*45000; // 25s to 70s
    const delay = Math.random()*2000;
    const amplitudeX = (8 + Math.random()*18); // vmin
    const amplitudeY = (6 + Math.random()*18);
    const rotateA = (Math.random()*30 - 15);
    const scaleA = 0.92 + Math.random()*0.18;
    const dir = (Math.random() < 0.5) ? -1 : 1;
    // create subtle opacity flicker
    const opacityKF = [
      { opacity: 0.48 + Math.random()*0.18, offset: 0 },
      { opacity: 0.5 + Math.random()*0.2, offset: 0.25 },
      { opacity: 0.44 + Math.random()*0.18, offset: 0.6 },
      { opacity: 0.5 + Math.random()*0.2, offset: 1 }
    ];
    // keyframes for translation/rotation/scale
    const kf = [
      { transform: `translate3d(0vmin, 0vmin, 0) rotate(${0}deg) scale(1)` },
      { transform: `translate3d(${dir * amplitudeX/2}vmin, ${-amplitudeY/3}vmin, 0) rotate(${rotateA/2}deg) scale(${scaleA})` },
      { transform: `translate3d(${-dir * amplitudeX}vmin, ${amplitudeY}vmin, 0) rotate(${ -rotateA }deg) scale(${1/scaleA})` },
      { transform: `translate3d(${dir * amplitudeX/3}vmin, ${-amplitudeY/2}vmin, 0) rotate(${rotateA/3}deg) scale(${scaleA})` },
      { transform: `translate3d(0vmin, 0vmin, 0) rotate(0deg) scale(1)` }
    ];
    // combine animations: transform + opacity
    el.animate(kf, { duration: baseDuration, iterations: Infinity, easing: 'ease-in-out', direction: 'alternate', delay: delay });
    el.animate(opacityKF, { duration: 8000 + Math.random()*12000, iterations: Infinity, easing: 'linear', direction: 'alternate', delay: delay/2 });
  });
})();


})();

});</script>

<!-- ==== GAME OVER (glass buttons, smooth log transition) ==== -->
<style>
  /* Overlay fade */
  #gameOverOverlay {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease;
  }
  #gameOverOverlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Card fade + scale */
  #gameOverOverlay .card {
    transform: scale(0.96);
    opacity: 0;
    transition: transform 0.35s ease, opacity 0.35s ease;
  }
  #gameOverOverlay.visible .card {
    transform: scale(1);
    opacity: 1;
  }

  /* Glass-style buttons */
  #gameOverOverlay .glass-btn {
    padding: 10px 16px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.25s ease, transform 0.2s ease;
  }
  #gameOverOverlay .glass-btn:hover {
    background: rgba(255, 255, 255, 0.18);
    transform: translateY(-1px);
  }
  #gameOverOverlay .glass-btn:active {
    transform: translateY(0);
  }

  /* Smooth log panel */
  #gameOverLog {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    background: rgba(255, 255, 255, 0.05);
    padding: 0 8px;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
    line-height: 1.4em;
    transition: max-height 0.35s ease, opacity 0.35s ease, padding 0.35s ease;
  }
  #gameOverLog.open {
    max-height: 200px;
    opacity: 1;
    padding: 6px 8px;
    overflow-y: auto;
  }
  /* Light mode adjustments for glass buttons in Game Over popup */
body.light-mode #gameOverOverlay .glass-btn {
  color: #1b1b1b; /* Dark text for visibility */
  border-color: rgba(0,0,0,0.25);
  background: rgba(255,255,255,0.4);
}
body.light-mode #gameOverOverlay .glass-btn:hover {
  background: rgba(255,255,255,0.55);
}
</style>

<div class="overlay" id="gameOverOverlay" aria-hidden="true" style="display:flex;align-items:center;justify-content:center;">
  <div class="card" style="max-width:520px;width:92%;text-align:center;">
    <div style="font-size:26px;font-weight:800;color:var(--accent-a);margin-bottom:12px;">
      Game Over
    </div>
    <div id="gameOverMessage" style="margin-bottom:12px;font-size:18px;font-weight:700;">
      Your reign has ended.
    </div>

    <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:8px;margin-top:8px;">
      <button class="glass-btn" id="toggleGameOverLog" style="width:100%;margin-bottom:6px;">Show Log</button>
      <div id="gameOverLog"><i>No log available.</i></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap;">
      <button class="glass-btn" id="restartGameOver" style="flex:1;min-width:120px;">Restart</button>
      <button class="glass-btn" id="dismissGameOver" style="flex:1;min-width:120px;">Dismiss</button>
    </div>
  </div>
</div>

<script>
(function () {
  const overlay     = document.getElementById('gameOverOverlay');
  const msgEl       = document.getElementById('gameOverMessage');
  const logEl       = document.getElementById('gameOverLog');
  const toggleBtn   = document.getElementById('toggleGameOverLog');
  const restartBtn  = document.getElementById('restartGameOver');
  const dismissBtn  = document.getElementById('dismissGameOver');

  let storedLogHTML = '<i>No log available.</i>';

  function show(reason) {
  // Run achievements check first
  if (typeof window.checkAchievements === 'function') {
    window.checkAchievements();
  }

  msgEl.textContent = reason || 'Your reign has ended.';

  // Wait until the DOM updates before capturing the log
  requestAnimationFrame(() => {
    let liveLog = document.querySelector('#log') || document.querySelector('.log');
    if (liveLog && liveLog.innerHTML.trim() !== '') {
      storedLogHTML = liveLog.innerHTML;
    } else {
      storedLogHTML = '<i>No log available.</i>';
    }

    logEl.classList.remove('open'); // ensure log is closed
    toggleBtn.textContent = 'Show Log';
    overlay.classList.add('visible');
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  });
}

  function hide() {
    overlay.classList.remove('visible');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  toggleBtn.addEventListener('click', () => {
    const willOpen = !logEl.classList.contains('open');
    if (willOpen) {
      logEl.innerHTML = storedLogHTML;
      logEl.classList.add('open');
    } else {
      logEl.classList.remove('open');
    }
    toggleBtn.textContent = willOpen ? 'Hide Log' : 'Show Log';
  });

  restartBtn.addEventListener('click', () => location.reload());
  dismissBtn.addEventListener('click', hide);

  window.showGameOverOverlay = show;
  window.hideGameOverOverlay = hide;
  window.triggerGameOver = (msg) => show(msg || 'Debug trigger');
})();
</script>
<!-- ==== /GAME OVER ==== -->
<script>
/* ==== CHILD MINI-GAME with per-decision results, gender awareness & hard-pause finale ==== */
(function () {
  if (window.__childMiniGameInjected) return;
  window.__childMiniGameInjected = true;

  window.state = window.state || {};
  state.childActive = false;
  state.childQueue = [];
  state.childRelationship = 0;
  state.childGender = "child"; // fallback if not set by q28

  // === Called in q28 accept branch ===
window.startChildMiniGame = function () {
  state.childActive = true;
  state.childRelationship = 0;

  // ensure gender is set by q28
  if (!state.childGender) state.childGender = "child";

  // ðŸ”¹ set derived fields so buildChildScenarios works
  if (state.childGender === "daughter") {
    state.childTitle = "Your Daughter";
    state.childPronoun = "she";
    state.childPossessive = "her";
  } else if (state.childGender === "son") {
    state.childTitle = "Your Son";
    state.childPronoun = "he";
    state.childPossessive = "his";
  } else {
    state.childTitle = "Your Child";
    state.childPronoun = "they";
    state.childPossessive = "their";
  }

  const scenarios = buildChildScenarios();

  const taken = state.decisionsThisDecade || 0;
  const remaining = Math.max(0, 6 - taken);
  const totalSlices = Math.min(scenarios.length, remaining + 1);
  state.childQueue = scenarios.slice(0, totalSlices);

  // ðŸŽ¬ Intro card always first
  showChildIntro(() => {
    const first = state.childQueue.shift();
    if (first) showChildSlice(first);
  });
};

  function buildChildScenarios() {
  window.state = window.state || {};
  const title = state.childTitle || "Your Child";
  const pronoun = state.childPronoun || "they";
  const poss = state.childPossessive || "their";

  return [
    {
      text: `${title} asks to play in the gardens.`,
      accept: "ðŸŒ¸ Play together",
      decline: "Not now",
      acceptResult: `${title} laughs with joy as you chase butterflies together.`,
      declineResult: `${title} looks down sadly, clutching a flower alone.`,
      effect: a => state.childRelationship += a ? 2 : 0
    },
    {
      text: `${title} shows you a family drawing with crowns too big.`,
      accept: "ðŸŽ¨ Praise warmly",
      decline: "Criticize",
      acceptResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} beams proudly and hugs you tightly.`,
      declineResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} hides the drawing, tears forming in the corners of ${poss} eyes.`,
      effect: a => state.childRelationship += a ? 1 : -1
    },
    {
      text: `${title} asks about your long life.`,
      accept: "ðŸ’« Answer gently",
      decline: "Avoid",
      acceptResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} listens quietly, comforted by your honesty.`,
      declineResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} frowns, sensing youâ€™re keeping secrets.`,
      effect: a => state.childRelationship += a ? 1 : 0
    },
    {
      text: `${title} wants a bedtime story.`,
      accept: "ðŸ“– Tell a story",
      decline: "Refuse",
      acceptResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} drifts to sleep smiling at your tale.`,
      declineResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} turns away in silence, sleep heavy with disappointment.`,
      effect: a => state.childRelationship += a ? 2 : -1
    },
    {
      text: `${title} weaves you a flower crown.`,
      accept: "ðŸ‘‘ Wear it proudly",
      decline: "Refuse",
      acceptResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} claps with delight as you wear the crown.`,
      declineResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} lets the flowers fall, petals scattering.`,
      effect: a => state.childRelationship += a ? 2 : -1
    },
    {
      text: `Rain taps windows: ${title} asks to build a fort.`,
      accept: "ðŸ° Blankets and chairs!",
      decline: "Not now",
      acceptResult: `The two of you build a mighty castle of cushions, giggling inside.`,
      declineResult: `${pronoun.charAt(0).toUpperCase()+pronoun.slice(1)} sighs and curls up alone in the corner.`,
      effect: a => state.childRelationship += a ? 2 : 0
    }
  ];
}

  // === Inject into main game decision loop ===
  document.addEventListener("click", ev => {
    if (!state.childActive) return;
    if (document.querySelector(".child-overlay.show")) return; // don't trigger if overlay open
    const btn = ev.target.closest('#acceptBtn, #declineBtn, #queenAgreeBtn, #queenRefuseBtn');
    if (!btn) return;
    if (!state.childQueue || state.childQueue.length === 0) return;

    setTimeout(() => {
      const next = state.childQueue.shift();
      if (next) showChildSlice(next);
    }, 0);
  }, true);

  /* === Intro Card === */
  function showChildIntro(callback) {
    const overlay = document.createElement("div");
    overlay.className = "child-overlay";
    overlay.innerHTML = `
      <div class="child-card intro">
        <div class="child-body">
          <p class="child-text">
            Because both parents are bound by immortal blood,<br>
            your ${state.childGender || "child"} will not survive past a decade.<br><br>
            Every moment you spend together matters.
          </p>
        </div>
        <div class="child-actions">
          <button class="child-btn child-accept" id="childIntroContinue">Continue</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add("show"));
    overlay.querySelector("#childIntroContinue").addEventListener("click", () => {
      overlay.classList.remove("show");
      overlay.classList.add("hide");
      setTimeout(() => { overlay.remove(); callback(); }, 250);
    });
  }

  /* === Scenario Card with Result === */
  function showChildSlice(node) {
    const title = state.childGender === "daughter" ? "Your Daughter" : state.childGender === "son" ? "Your Son" : "Your Child";
    const overlay = document.createElement("div");
    overlay.className = "child-overlay";

    overlay.innerHTML = `
      <div class="child-card">
        <div class="child-header">
          <div class="child-badge">${title}</div>
          <div class="child-rel">${renderRelationshipBar(state.childRelationship)}</div>
        </div>
        <div class="child-body">
          <p class="child-text">${node.text}</p>
        </div>
        <div class="child-actions">
          <button class="child-btn child-accept">${node.accept}</button>
          <button class="child-btn child-decline">${node.decline}</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add("show"));

    const accept = overlay.querySelector(".child-accept");
    const decline = overlay.querySelector(".child-decline");
    const body = overlay.querySelector(".child-body");
    const actions = overlay.querySelector(".child-actions");

    const resolve = accepted => {
      node.effect(accepted);

      // Show result text in the same card
      body.innerHTML = `<p class="child-text">${accepted ? node.acceptResult : node.declineResult}</p>`;
      overlay.querySelector(".child-rel").innerHTML = renderRelationshipBar(state.childRelationship);

      // Replace buttons with "Continue"
      actions.innerHTML = `<button class="child-btn child-accept">Continue</button>`;
      actions.querySelector("button").addEventListener("click", () => {
        overlay.classList.remove("show");
        overlay.classList.add("hide");
        setTimeout(() => {
          overlay.remove();
          if (!state.childQueue || state.childQueue.length === 0) {
            showChildFinaleCard();
            state.childActive = false;
          }
        }, 250);
      });
    };

    accept.addEventListener("click", () => resolve(true));
    decline.addEventListener("click", () => resolve(false));
  }

  /* === Finale Card (hard pause until player continues) === */
  function showChildFinaleCard() {
    let msg, tone;
    if (state.childRelationship >= 5) {
      tone = "tear";
      msg = "ðŸŒŸ Their short life leaves a memory you will carry for centuries.";
    } else if (state.childRelationship >= 3) {
      tone = "warm";
      msg = "ðŸ’– Though brief, your time together created a warm story.";
    } else {
      tone = "quiet";
      msg = "ðŸŒ™ A soft thank you before fading, leaving the Queenâ€™s sorrow.";
    }

    const overlay = document.createElement("div");
    overlay.className = "child-overlay";
    overlay.innerHTML = `
      <div class="child-card finale ${tone}">
        <div class="child-header">
          <div class="child-badge">Finale</div>
          <div class="child-rel">${renderRelationshipBar(state.childRelationship)}</div>
        </div>
        <div class="child-body"><p class="child-text">${msg}</p></div>
        <div class="child-actions">
          <button class="child-btn child-accept" id="childFinalContinue">Continue</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add("show"));

    // hard pause, resume only after Continue
    overlay.querySelector("#childFinalContinue").addEventListener("click", () => {
      overlay.classList.remove("show");
      overlay.classList.add("hide");
      setTimeout(() => {
        overlay.remove();
        if (typeof presentScene === "function" && typeof nextScene === "function") {
          presentScene(nextScene());
        }
      }, 250);
    });
  }

  function renderRelationshipBar(value) {
    const max = 6;
    const colors = ["#ff6b6b", "#feca57", "#48dbfb", "#1dd1a1", "#5f27cd", "#ff9ff3"];
    let html = "";
    for (let i = 1; i <= max; i++) {
      const filled = i <= value;
      html += `<div class="child-bar-segment ${filled ? 'filled' : ''}" 
                  style="${filled ? 'background:'+colors[i-1] : ''}"></div>`;
    }
    return html;
  }

  /* === CSS Styling === */
  if (!document.getElementById("childMiniGameCSS")) {
    const style = document.createElement("style");
    style.id = "childMiniGameCSS";
    style.textContent = `
      .child-overlay {
        position: fixed; inset: 0; display: grid; place-items: center;
        backdrop-filter: blur(8px);
        background: rgba(0,0,0,.45);
        opacity: 0; transition: opacity .25s ease;
        z-index: 9999;
      }
      .child-overlay.show { opacity: 1; }
      .child-overlay.hide { opacity: 0; }
      .child-card {
        width: min(540px, 92vw);
        border-radius: 18px;
        padding: 20px;
        background: linear-gradient(135deg, #fef9e7, #fcefee);
        box-shadow: 0 6px 24px rgba(0,0,0,.25);
        transform: translateY(10px) scale(.96);
        opacity: 0;
        transition: transform .25s ease, opacity .25s ease;
        text-align: center;
        color: #333;
        animation: childCardPop .35s ease;
      }
      .child-overlay.show .child-card { transform: translateY(0) scale(1); opacity: 1; }
      .child-overlay.hide .child-card { transform: translateY(10px) scale(.96); opacity: 0; }
      .child-header { display:flex; justify-content:space-between; align-items:center; }
      .child-badge { font-weight:800; font-size:14px; padding:6px 10px; border-radius:999px;
        background:#ffeaa7; border:2px solid #fdcb6e; }
      .child-rel { display:flex; gap:6px; }
      .child-bar-segment {
        width: 28px; height: 18px; border-radius: 4px;
        border:1px solid #444; background:transparent; transition:transform .3s ease;
      }
      .child-bar-segment.filled { transform: scale(1.1); animation:bounce .4s ease; }
      .child-text { font-size:18px; font-weight:600; margin:12px 0; }
      .child-actions { display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
      .child-btn { padding:10px 16px; border-radius:12px; font-size:15px; font-weight:700; border:none; cursor:pointer;
        transition: transform .2s ease, background .2s ease; }
      .child-btn:hover { transform: translateY(-2px); }
      .child-accept { background:#6fcf97; color:#fff; }
      .child-accept:hover { background:#57b67f; }
      .child-decline { background:#eb5757; color:#fff; }
      .child-decline:hover { background:#c94c4c; }
      .child-card.finale.tear { border:2px solid #ff9ff3; }
      .child-card.finale.warm { border:2px solid #feca57; }
      .child-card.finale.quiet { border:2px solid #48dbfb; }
      @keyframes childCardPop { from{transform:scale(.9);opacity:0;} to{transform:scale(1);opacity:1;} }
      @keyframes bounce { 0%{transform:scale(.8);}50%{transform:scale(1.15);}100%{transform:scale(1);} }
    `;
    document.head.appendChild(style);
  }
})();
</script>


</body>
</html>
